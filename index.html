<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Stock Tracker">
<title>Stock Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f7f7f5;
    --surface: #ffffff;
    --surface2: #f0f0ee;
    --border: #e8e8e5;
    --border2: #d8d8d4;
    --text: #1a1a18;
    --text2: #6b6b65;
    --text3: #9b9b93;
    --accent: #1a1a18;
    --green: #1a9e5c;
    --green-bg: #edf7f2;
    --red: #d63b3b;
    --red-bg: #fdf0f0;
    --blue: #2563eb;
    --blue-bg: #eff4ff;
    --shadow: 0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.05);
    --shadow-lg: 0 20px 60px rgba(0,0,0,0.12), 0 8px 20px rgba(0,0,0,0.06);
    --radius: 14px;
    --radius-sm: 8px;
    --radius-xs: 5px;
    --tab-height: 72px;
    --header-height: 56px;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --font: 'DM Sans', sans-serif;
    --mono: 'DM Mono', monospace;
  }

  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
  
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    overflow: hidden;
    background: var(--bg);
    font-family: var(--font);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    overscroll-behavior: none;
  }

  #app {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    padding-top: env(safe-area-inset-top, 0px);
    /* Must clip children so flex layout fills exactly to bottom edge */
    overflow: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    flex-shrink: 0;
    height: var(--header-height);
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    justify-content: space-between;
    position: relative;
    z-index: 10;
  }
  .header-title {
    font-size: 17px;
    font-weight: 600;
    letter-spacing: -0.3px;
    color: var(--text);
  }
  .header-subtitle {
    font-size: 12px;
    color: var(--text3);
    font-family: var(--mono);
    margin-top: 1px;
  }
  .header-action {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    color: white;
    font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
    font-weight: 300;
    line-height: 1;
  }
  .header-action:active { transform: scale(0.92); opacity: 0.8; }

  /* â”€â”€ SCREENS â”€â”€ */
  .screen-container {
    flex: 1;
    overflow: hidden;
    position: relative;
    /* min-height:0 is critical â€” without it, flex children won't shrink below content size */
    min-height: 0;
  }
  .screen {
    position: absolute;
    inset: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    display: none;
    padding-bottom: 20px;
  }
  .screen.active { display: block; }

  /* â”€â”€ TAB BAR â”€â”€
     Height = 49px icons+labels + safe area bottom inset (home indicator on iPhone).
     We use padding-bottom so the home indicator area stays blank below the labels.
     The 0px fallback is intentional: on non-notched devices no extra space is needed. */
  .tab-bar {
    flex-shrink: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    padding-top: 8px;
    padding-bottom: env(safe-area-inset-bottom, 0px);
    z-index: 10;
  }
  .tab-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0 0 6px 0;
    transition: opacity 0.15s;
  }
  .tab-btn:active { opacity: 0.6; }
  .tab-icon {
    width: 26px; height: 26px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .tab-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--text3);
    letter-spacing: 0.2px;
    transition: color 0.15s;
  }
  .tab-btn.active .tab-label { color: var(--text); }
  .tab-btn.active .tab-icon svg { stroke: var(--text); }
  .tab-btn .tab-icon svg { stroke: var(--text3); transition: stroke 0.15s; }

  /* â”€â”€ SCROLL CONTENT â”€â”€ */
  .page-content {
    padding: 16px 16px 0;
  }

  /* â”€â”€ KPI CARDS â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .kpi-card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 14px 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .kpi-card.full { grid-column: 1 / -1; }
  .kpi-label {
    font-size: 11px;
    color: var(--text3);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .kpi-value {
    font-size: 22px;
    font-weight: 600;
    font-family: var(--mono);
    letter-spacing: -0.5px;
    color: var(--text);
  }
  .kpi-value.positive { color: var(--green); }
  .kpi-value.negative { color: var(--red); }
  .kpi-change {
    font-size: 12px;
    font-family: var(--mono);
    margin-top: 3px;
    font-weight: 500;
  }
  .kpi-change.positive { color: var(--green); }
  .kpi-change.negative { color: var(--red); }

  /* â”€â”€ SECTION HEADER â”€â”€ */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }

  /* â”€â”€ TOGGLE â”€â”€ */
  .toggle-group {
    display: flex;
    background: var(--surface2);
    border-radius: var(--radius-xs);
    padding: 2px;
    gap: 1px;
  }
  .toggle-btn {
    font-size: 11px;
    font-weight: 500;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: transparent;
    color: var(--text3);
    transition: all 0.15s;
    font-family: var(--font);
  }
  .toggle-btn.active {
    background: var(--surface);
    color: var(--text);
    box-shadow: var(--shadow);
  }

  /* â”€â”€ STOCKS TABLE â”€â”€ */
  .table-wrap {
    background: var(--surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 16px;
    position: relative;
  }
  .stocks-table {
    width: 100%;
    min-width: 480px;
    border-collapse: separate; /* needed for sticky to work with border-radius */
    border-spacing: 0;
    font-size: 13px;
  }
  .stocks-table thead tr {
    border-bottom: 1px solid var(--border);
  }
  .stocks-table th {
    padding: 10px 12px;
    text-align: left;
    font-size: 10.5px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .stocks-table th:hover { color: var(--text); }
  .stocks-table th.sorted { color: var(--text); }
  .sort-arrow { margin-left: 3px; font-size: 9px; }
  .stocks-table th.right, .stocks-table td.right { text-align: right; }
  /* Sticky first column */
  .stocks-table th:first-child,
  .stocks-table td:first-child {
    position: sticky;
    left: 0;
    background: var(--surface);
    z-index: 2;
    /* Thin right border to visually separate sticky col from scrolling cols */
    box-shadow: 1px 0 0 var(--border);
  }
  .stocks-table tbody tr:active td:first-child { background: var(--surface2); }
  .stocks-table td {
    padding: 13px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  .stocks-table tbody tr:last-child td { border-bottom: none; }
  .stocks-table tbody tr { transition: background 0.1s; }
  .stocks-table tbody tr:active { background: var(--surface2); }
  .ticker-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .ticker-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    cursor: pointer;
    text-decoration: none;
  }
  .ticker-name:active { opacity: 0.7; }
  .ticker-shares {
    font-size: 11px;
    color: var(--text3);
    font-family: var(--mono);
  }
  .price-cell {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 500;
  }
  .change-pill {
    display: inline-flex;
    align-items: center;
    padding: 3px 7px;
    border-radius: 20px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
  }
  .change-pill.positive { background: var(--green-bg); color: var(--green); }
  .sub-row td { background: var(--surface2) !important; font-size: 12px; }
  .sub-row td:first-child { padding-left: 32px !important; }
  .lot-chevron { display:inline-block; transition: transform 0.2s; margin-right:6px; font-size:10px; color:var(--text3); cursor:pointer; }
  .lot-chevron.open { transform: rotate(90deg); }
  tr.expandable-row { cursor: pointer; }
  tr.expandable-row:hover td { background: var(--surface2); }
  .change-pill.negative { background: var(--red-bg); color: var(--red); }
  .change-pill.neutral { background: var(--surface2); color: var(--text3); }

  /* Change period selector */
  .period-select-wrap {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .period-dots {
    font-size: 10px;
    color: var(--text3);
    cursor: pointer;
  }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty-state {
    padding: 50px 20px;
    text-align: center;
    color: var(--text3);
  }
  .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
  .empty-state h3 { font-size: 16px; color: var(--text2); margin-bottom: 6px; }
  .empty-state p { font-size: 13px; line-height: 1.5; }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 100;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
    padding-bottom: var(--safe-bottom);
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }
  .modal {
    background: var(--surface);
    border-radius: 22px 22px 0 0;
    width: 100%;
    max-width: 500px;
    padding: 20px 20px 32px;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-overlay.open .modal {
    transform: translateY(0);
  }
  .modal-handle {
    width: 36px; height: 4px;
    background: var(--border2);
    border-radius: 2px;
    margin: 0 auto 20px;
  }
  .modal-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
  }

  /* â”€â”€ FORM â”€â”€ */
  .form-group {
    margin-bottom: 14px;
  }
  .form-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
    display: block;
  }
  .form-input {
    width: 100%;
    padding: 13px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-family: var(--font);
    color: var(--text);
    background: var(--bg);
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }
  .form-input:focus { border-color: var(--accent); }
  .form-input::placeholder { color: var(--text3); }
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .form-type-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 20px;
  }
  .type-btn {
    padding: 12px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    background: transparent;
    cursor: pointer;
    transition: all 0.15s;
    font-family: var(--font);
    color: var(--text2);
  }
  .type-btn.buy.active {
    background: var(--green-bg);
    border-color: var(--green);
    color: var(--green);
  }
  .type-btn.sell.active {
    background: var(--red-bg);
    border-color: var(--red);
    color: var(--red);
  }

  /* Autocomplete dropdown */
  .autocomplete-wrap { position: relative; }
  .autocomplete-list {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-md);
    z-index: 200;
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }
  .autocomplete-list.show { display: block; }
  .autocomplete-item {
    padding: 11px 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:active { background: var(--surface2); }
  .autocomplete-ticker { font-weight: 600; font-size: 14px; }
  .autocomplete-name { font-size: 12px; color: var(--text3); margin-top: 1px; }

  /* â”€â”€ BUTTON â”€â”€ */
  .btn-primary {
    width: 100%;
    padding: 15px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-weight: 600;
    font-family: var(--font);
    cursor: pointer;
    transition: opacity 0.15s, transform 0.15s;
    margin-top: 8px;
  }
  .btn-primary:active { opacity: 0.85; transform: scale(0.99); }
  .btn-secondary {
    width: 100%;
    padding: 14px;
    background: transparent;
    color: var(--text);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-weight: 500;
    font-family: var(--font);
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.15s;
  }
  .btn-secondary:active { background: var(--surface2); }
  .btn-danger {
    background: var(--red-bg);
    color: var(--red);
    border-color: var(--red);
  }

  /* â”€â”€ STOCK DETAIL SCREEN â”€â”€ */
  .stock-detail-header {
    padding: 16px 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  .back-btn {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: var(--surface);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 16px;
    flex-shrink: 0;
    box-shadow: var(--shadow);
    transition: all 0.15s;
  }
  .back-btn:active { background: var(--surface2); }
  .stock-detail-info {}
  .stock-detail-ticker {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .stock-detail-company {
    font-size: 13px;
    color: var(--text3);
    margin-top: 1px;
  }
  .stock-detail-price {
    margin-left: auto;
    text-align: right;
  }
  .stock-detail-price-val {
    font-size: 22px;
    font-weight: 600;
    font-family: var(--mono);
    letter-spacing: -0.5px;
  }
  .stock-detail-price-change {
    font-size: 12px;
    font-family: var(--mono);
    font-weight: 500;
    margin-top: 2px;
  }
  .stock-detail-price-change.positive { color: var(--green); }
  .stock-detail-price-change.negative { color: var(--red); }

  /* â”€â”€ PRICE CHANGE TABLE â”€â”€ */
  .price-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .price-table th {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text3);
    padding: 9px 13px;
    text-align: right;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }
  .price-table th:first-child { text-align: left; }
  .price-table td {
    padding: 10px 13px;
    text-align: right;
    border-bottom: 1px solid var(--border);
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text);
  }
  .price-table td:first-child {
    text-align: left;
    font-family: var(--font);
    font-weight: 500;
    color: var(--text2);
    font-size: 12px;
  }
  .price-table tr:last-child td { border-bottom: none; }
  .price-table .tbl-na { color: var(--text3); font-size: 11px; font-family: var(--font); }
  .price-table .tbl-loading { color: var(--text3); font-size: 12px; font-family: var(--font); text-align: center; padding: 16px; }

  /* â”€â”€ ANALYST BAR â”€â”€ */
  .analyst-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    box-shadow: var(--shadow);
  }
  .analyst-row { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; }
  .analyst-row:last-of-type { margin-bottom: 0; }
  .analyst-lbl { font-size: 12px; color: var(--text2); width: 84px; flex-shrink: 0; }
  .analyst-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .analyst-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
  .analyst-cnt { font-size: 12px; font-family: var(--mono); color: var(--text2); width: 24px; text-align: right; flex-shrink: 0; }

  /* â”€â”€ NEWS CARDS â”€â”€ */
  .news-card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .news-card a {
    display: flex;
    gap: 12px;
    padding: 12px 14px;
    text-decoration: none;
    color: inherit;
  }
  .news-thumb {
    width: 68px; height: 68px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    background: var(--surface2);
  }
  .news-body { flex: 1; min-width: 0; }
  .news-headline {
    font-size: 13px; font-weight: 600; line-height: 1.35; color: var(--text);
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
  }
  .news-meta { font-size: 11px; color: var(--text3); margin-top: 5px; display: flex; gap: 6px; align-items: center; }
  .news-source { background: var(--surface2); border-radius: 3px; padding: 1px 5px; font-weight: 600; font-size: 10px; color: var(--text2); }
  .news-sec-hdr {
    font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px;
    color: var(--text3); padding: 16px 16px 8px;
  }
  .news-sec-hdr:first-child { padding-top: 8px; }

  /* â”€â”€ EARNINGS CALENDAR â”€â”€ */
  .cal-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .cal-item:last-child { border-bottom: none; }
  .cal-datebox { width: 42px; text-align: center; flex-shrink: 0; background: var(--accent); border-radius: 6px; padding: 4px 3px; color: white; }
  .cal-mon { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .cal-day { font-size: 18px; font-weight: 700; line-height: 1.1; }
  .cal-info { flex: 1; }
  .cal-title { font-size: 13px; font-weight: 600; }
  .cal-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }

  /* â”€â”€ PRICE TARGET TILES â”€â”€ */
  .pt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 16px 4px; }
  .pt-tile {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 12px 14px; box-shadow: var(--shadow);
  }
  .pt-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text3); margin-bottom: 4px; }
  .pt-val { font-size: 17px; font-weight: 700; font-family: var(--mono); color: var(--text); }
  .pt-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }

  /* â”€â”€ TRANSACTIONS â”€â”€ */
  .transaction-list {
    padding: 0 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }
  .transaction-card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .tx-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .tx-dot.buy { background: var(--green); }
  .tx-dot.sell { background: var(--red); }
  .tx-info { flex: 1; }
  .tx-main {
    font-size: 14px;
    font-weight: 500;
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .tx-badge {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 3px;
    letter-spacing: 0.5px;
  }
  .tx-badge.buy { background: var(--green-bg); color: var(--green); }
  .tx-badge.sell { background: var(--red-bg); color: var(--red); }
  .tx-sub {
    font-size: 12px;
    color: var(--text3);
    margin-top: 3px;
    font-family: var(--mono);
  }
  .tx-amount {
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 600;
    text-align: right;
  }
  .tx-amount.positive { color: var(--green); }
  .tx-amount.negative { color: var(--red); }
  .tx-edit-btn {
    width: 30px; height: 30px;
    border-radius: 50%;
    background: var(--surface2);
    border: none;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    transition: background 0.15s;
  }
  .tx-edit-btn:active { background: var(--border); }

  /* â”€â”€ SETTINGS â”€â”€ */
  .settings-section {
    margin: 0 16px 16px;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .settings-section-title {
    padding: 14px 16px 10px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--text3);
    border-bottom: 1px solid var(--border);
  }
  .settings-row {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .settings-row:last-child { border-bottom: none; }
  .settings-row-label { font-size: 14px; font-weight: 500; }
  .settings-row-sub { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .settings-btn {
    padding: 8px 14px;
    border-radius: var(--radius-xs);
    font-size: 13px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-family: var(--font);
    transition: all 0.15s;
    white-space: nowrap;
  }
  .settings-btn:active { opacity: 0.75; }
  .settings-btn.primary { background: var(--accent); color: white; }
  .settings-btn.outline { background: transparent; border: 1.5px solid var(--border2); color: var(--text); }
  .settings-btn.danger { background: var(--red-bg); color: var(--red); }
  .settings-input-full {
    width: 100%;
    padding: 11px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-family: var(--mono);
    color: var(--text);
    background: var(--bg);
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }
  .settings-input-full:focus { border-color: var(--accent); }
  .step-list {
    padding: 14px 16px;
  }
  .step-item {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }
  .step-item:last-child { margin-bottom: 0; }
  .step-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    font-size: 11px;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .step-content {}
  .step-title { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
  .step-desc { font-size: 12px; color: var(--text2); line-height: 1.5; }
  .step-code {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text);
    margin-top: 6px;
    word-break: break-all;
    line-height: 1.6;
  }
  .sync-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text3);
  }
  .sync-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
  }
  .sync-dot.connected { background: var(--green); }
  .sync-dot.syncing { background: var(--blue); animation: pulse 1s infinite; }
  .sync-dot.error { background: var(--red); }
  @keyframes pulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.4; }
  }

  /* â”€â”€ LOADING â”€â”€ */
  .price-loading {
    display: inline-block;
    width: 40px; height: 10px;
    background: linear-gradient(90deg, var(--border) 25%, var(--border2) 50%, var(--border) 75%);
    background-size: 200%;
    border-radius: 3px;
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed;
    top: calc(var(--safe-top) + 60px);
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    background: var(--text);
    color: white;
    padding: 10px 18px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    z-index: 999;
    opacity: 0;
    transition: all 0.25s;
    white-space: nowrap;
    pointer-events: none;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  .toast.success { background: var(--green); }
  .toast.error { background: var(--red); }

  /* â”€â”€ PERIOD CHANGE BAR â”€â”€ */
  .change-period-bar {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .change-period-mini {
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    border: none;
    background: transparent;
    color: var(--text3);
    cursor: pointer;
    font-family: var(--font);
    transition: all 0.15s;
  }
  .change-period-mini.active {
    background: var(--surface2);
    color: var(--text);
  }

  /* Misc */
  .divider { height: 1px; background: var(--border); margin: 4px 0; }
  .text-center { text-align: center; }
  .mt8 { margin-top: 8px; }
  .mt16 { margin-top: 16px; }
  .color-green { color: var(--green); }
  .color-red { color: var(--red); }

  .detail-info-card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    margin: 0 16px 16px;
    overflow: hidden;
  }
  .detail-info-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }
  .detail-info-row:last-child { border-bottom: none; }
  .detail-info-label { font-size: 13px; color: var(--text3); }
  .detail-info-val { font-size: 13px; font-weight: 600; font-family: var(--mono); }

  .section-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text3);
    padding: 0 16px;
    margin-bottom: 10px;
    margin-top: 4px;
  }

  /* Alert/confirm */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .confirm-overlay.open { opacity: 1; pointer-events: all; }
  .confirm-box {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 24px;
    width: 100%;
    max-width: 320px;
    box-shadow: var(--shadow-lg);
    transform: scale(0.95);
    transition: transform 0.2s;
  }
  .confirm-overlay.open .confirm-box { transform: scale(1); }
  .confirm-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
  .confirm-msg { font-size: 13px; color: var(--text2); line-height: 1.5; margin-bottom: 20px; }
  .confirm-actions { display: flex; gap: 8px; }
  .confirm-actions button {
    flex: 1; padding: 12px; border-radius: var(--radius-sm);
    font-size: 14px; font-weight: 600; border: none;
    cursor: pointer; font-family: var(--font); transition: opacity 0.15s;
  }
  .confirm-actions button:active { opacity: 0.8; }
  .confirm-cancel { background: var(--surface2); color: var(--text); }
  .confirm-ok { background: var(--accent); color: white; }
  .confirm-ok.danger { background: var(--red); }
</style>
</head>
<body>
<div id="app">
  <!-- HEADER -->
  <div class="header" id="main-header">
    <div>
      <div class="header-title" id="header-title">Portfolio</div>
      <div class="header-subtitle" id="header-subtitle" style="display:none"></div>
    </div>
    <button class="header-action" id="add-btn" onclick="openAddModal()" title="Add Transaction">+</button>
  </div>

  <!-- SCREENS -->
  <div class="screen-container">

    <!-- HOME SCREEN -->
    <div class="screen active" id="screen-home">
      <div class="page-content">
        <!-- KPIs -->
        <div class="kpi-grid" id="home-kpis">
          <div class="kpi-card full">
            <div class="kpi-label">Total Portfolio Value</div>
            <div class="kpi-value" id="kpi-total-value">â€”</div>
            <div class="kpi-change" id="kpi-total-change"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Invested</div>
            <div class="kpi-value" id="kpi-invested">â€”</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Unrealized P&L</div>
            <div class="kpi-value" id="kpi-unrealized">â€”</div>
            <div class="kpi-change" id="kpi-unrealized-pct"></div>
          </div>
          <div class="kpi-card full">
            <div class="kpi-label">Realized Gains (Sold)</div>
            <div class="kpi-value" id="kpi-realized">â€”</div>
          </div>
        </div>

        <!-- Rate Limit Banner â€” shown only when AV rate limit was hit today -->
        <div id="rate-limit-banner" style="display:none;align-items:center;gap:10px;background:#fef2f2;border:1.5px solid #fca5a5;border-radius:var(--radius);padding:11px 14px;margin-bottom:10px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <div style="flex:1">
            <div style="font-size:12px;font-weight:600;color:#dc2626">API rate limit reached today</div>
            <div style="font-size:11px;color:#ef4444;margin-top:1px">Showing last saved prices. Rate limit resets after 1 minute.</div>
          </div>
        </div>

        <!-- Last Refreshed Card -->
        <div id="last-refresh-bar" style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:13px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow)">
          <div>
            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);margin-bottom:3px">Prices Last Updated</div>
            <div style="font-size:13px;font-weight:500;color:var(--text)" id="home-last-refresh">Never refreshed</div>
          </div>
          <button onclick="refreshAllPrices()" id="refresh-btn"
            style="display:flex;align-items:center;gap:6px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius-sm);padding:9px 16px;font-size:13px;font-weight:600;font-family:var(--font);cursor:pointer;transition:opacity 0.15s;flex-shrink:0"
            ontouchstart="this.style.opacity='0.75'" ontouchend="this.style.opacity='1'">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" id="refresh-icon"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Refresh
          </button>
        </div>

        <!-- No-prices notice â€” shown when holdings exist but prices haven't loaded -->
        <div id="no-prices-notice" style="display:none;align-items:center;gap:10px;background:#fffbeb;border:1.5px solid #fcd34d;border-radius:var(--radius);padding:11px 14px;margin-bottom:10px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <div style="font-size:12px;color:#92400e">Live prices not yet loaded â€” tap <strong>Refresh</strong> to fetch current prices.</div>
        </div>

        <!-- Holdings Table -->
        <div class="section-header">
          <div class="section-title">Holdings</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="change-period-bar">
              <button class="change-period-mini active" data-period="1d" onclick="setChangePeriod('1d',this)">1D</button>
              <button class="change-period-mini" data-period="1w" onclick="setChangePeriod('1w',this)">1W</button>
              <button class="change-period-mini" data-period="1m" onclick="setChangePeriod('1m',this)">1M</button>
              <button class="change-period-mini" data-period="1y" onclick="setChangePeriod('1y',this)">1Y</button>
            </div>
            <div class="toggle-group">
              <button class="toggle-btn active" onclick="setViewMode('total',this)">$</button>
              <button class="toggle-btn" onclick="setViewMode('per',this)">/ share</button>
            </div>
          </div>
        </div>
      </div>

      <div style="padding: 0 16px 0">
        <div class="table-wrap">
          <table class="stocks-table" id="holdings-table">
            <thead>
              <tr id="table-head-row"></tr>
            </thead>
            <tbody id="holdings-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- DETAIL SCREEN -->
    <div class="screen" id="screen-detail">
      <!-- Stock selector dropdown row -->
      <div style="padding:12px 16px 0;display:flex;align-items:center;gap:10px">
        <div style="position:relative;flex:1">
          <select id="stock-select" onchange="navigate('detail', this.value)"
            style="width:100%;padding:9px 32px 9px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
                   font-size:15px;font-weight:600;font-family:var(--font);color:var(--text);background:var(--surface);
                   -webkit-appearance:none;appearance:none;outline:none;cursor:pointer">
          </select>
          <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--text3);font-size:12px">â–¼</span>
        </div>
      </div>
      <div class="stock-detail-header" id="detail-header"></div>
      <div class="kpi-grid" style="padding:0 16px;margin-bottom:16px" id="detail-kpis"></div>
      <p class="section-label">Price Performance</p>
      <div id="detail-price-table" style="margin:0 16px 16px"></div>
      <p class="section-label">Analyst Ratings</p>
      <div id="detail-analyst" style="margin:0 16px 16px;color:var(--text3);font-size:13px">Loadingâ€¦</div>
      <p class="section-label">Stock Details</p>
      <div class="detail-info-card" id="detail-info-card"></div>
      <p class="section-label mt16">Purchase History</p>
      <div class="transaction-list" id="detail-tx-list"></div>
    </div>

    <!-- HISTORY SCREEN -->
    <div class="screen" id="screen-history">
      <div class="page-content">
        <div class="section-header">
          <div class="section-title">All Transactions</div>
          <div id="history-count" style="font-size:12px;color:var(--text3)"></div>
        </div>
      </div>
      <div class="transaction-list" id="history-list"></div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div class="screen" id="screen-settings">
      <div class="page-content">
        <div class="section-header">
          <div class="section-title">Settings</div>
        </div>
      </div>

      <!-- Sync Status -->
      <div class="settings-section">
        <div class="settings-section-title">Google Sheets Sync</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Connection Status</div>
            <div class="sync-status mt8" id="sync-status-row">
              <div class="sync-dot" id="sync-dot"></div>
              <span id="sync-status-text">Not configured</span>
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="settings-btn primary" onclick="syncNow()" style="flex:1">&#8593; Push to Sheets</button>
            <button class="settings-btn outline" onclick="syncFromSheets()" id="sync-from-sheets-btn" style="flex:1">&#8595; Load from Sheets</button>
          </div>
        </div>
        <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="settings-row-label">Apps Script URL</div>
          <input class="settings-input-full" id="sheets-url-input" type="url"
            placeholder="https://script.google.com/macros/s/.../exec"
            oninput="saveSheetUrl()">
          <div style="font-size:11px;color:var(--text3)">Paste your deployed Apps Script web app URL here</div>
        </div>
      </div>

      <!-- Setup Guide -->
      <div class="settings-section">
        <div class="settings-section-title">ðŸ“‹ Google Sheets Setup Guide</div>
        <div class="step-list">
          <div class="step-item">
            <div class="step-num">1</div>
            <div class="step-content">
              <div class="step-title">Create a new Google Sheet</div>
              <div class="step-desc">Go to sheets.google.com and create a new spreadsheet. Name it "Stock Tracker" or anything you like.</div>
            </div>
          </div>
          <div class="step-item">
            <div class="step-num">2</div>
            <div class="step-content">
              <div class="step-title">Open Apps Script</div>
              <div class="step-desc">In your Sheet, click <strong>Extensions â†’ Apps Script</strong>. Delete any existing code in the editor.</div>
            </div>
          </div>
          <div class="step-item">
            <div class="step-num">3</div>
            <div class="step-content">
              <div class="step-title">Paste the Apps Script code</div>
              <div class="step-desc">Copy the entire code below and paste it into the Apps Script editor, then click Save (ðŸ’¾).</div>
              <div class="step-code" id="apps-script-code-display" style="cursor:pointer" onclick="copyAppsScript()">
                <em>Tap to copy the Apps Script code â†’</em>
              </div>
              <button class="settings-btn outline mt8" onclick="copyAppsScript()" style="width:100%">ðŸ“‹ Copy Apps Script Code</button>
            </div>
          </div>
          <div class="step-item">
            <div class="step-num">4</div>
            <div class="step-content">
              <div class="step-title">Deploy as Web App</div>
              <div class="step-desc">Click <strong>Deploy â†’ New deployment</strong>. Set type to <strong>Web app</strong>. Set "Execute as" to <strong>Me</strong> and "Who has access" to <strong>Anyone</strong>. Click Deploy and copy the URL.</div>
            </div>
          </div>
          <div class="step-item">
            <div class="step-num">5</div>
            <div class="step-content">
              <div class="step-title">Authorize & paste URL</div>
              <div class="step-desc">Authorize the app when prompted (click "Advanced" â†’ "Go toâ€¦" if needed). Paste the deployment URL into the field above, then tap <strong>Sync Now</strong>.</div>
            </div>
          </div>
          <div class="step-item">
            <div class="step-num">6</div>
            <div class="step-content">
              <div class="step-title">Stock prices (Finnhub)</div>
              <div class="step-desc">For live prices, get a free API key at <strong>finnhub.io</strong> â€” free tier allows 60 calls/minute with no daily limit.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- API Key -->
      <div class="settings-section">
        <div class="settings-section-title">Live Stock Prices</div>
        <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="settings-row-label">Finnhub API Key</div>
          <input class="settings-input-full" id="av-api-key" type="text"
            placeholder="Your free API key from finnhub.io"
            oninput="saveApiKey()">
          <div style="font-size:11px;color:var(--text3)">Free tier: 60 calls/minute, no daily limit. Get your key at finnhub.io</div>
        </div>
        <div class="settings-row" style="justify-content:space-between">
          <div>
            <div class="settings-row-label">Last Price Refresh</div>
            <div id="last-refresh-time" style="font-size:12px;color:var(--text3);margin-top:2px">Never</div>
          </div>
          <button class="settings-btn outline" onclick="refreshAllPrices()">Refresh Prices</button>
        </div>
      </div>

      <!-- News Feed Accounts -->
      <div class="settings-section">
        <div class="settings-section-title">News Feed Accounts</div>
        <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="settings-row-label">Twitter / X Accounts</div>
          <div id="twitter-accounts-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:4px"></div>
          <div style="display:flex;gap:8px">
            <input class="settings-input-full" id="twitter-add-input" type="text"
              placeholder="@username"
              style="flex:1"
              onkeydown="if(event.key==='Enter')addTwitterAccount()">
            <button class="settings-btn primary" onclick="addTwitterAccount()" style="flex-shrink:0;white-space:nowrap">Add</button>
          </div>
          <div style="font-size:11px;color:var(--text3)">Accounts appear as embedded feeds on the News tab.</div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="settings-section">
        <div class="settings-section-title">Data</div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Export Data</div>
            <div class="settings-row-sub">Download transactions as JSON</div>
          </div>
          <button class="settings-btn outline" onclick="exportData()">Export</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Import Data</div>
            <div class="settings-row-sub">Load from JSON backup</div>
          </div>
          <button class="settings-btn outline" onclick="document.getElementById('import-file').click()">Import</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Clear All Data</div>
            <div class="settings-row-sub">Cannot be undone</div>
          </div>
          <button class="settings-btn danger" onclick="confirmClearData()">Clear</button>
        </div>
      </div>

      <div style="height:20px"></div>
    </div>

    <!-- NEWS SCREEN -->
    <div class="screen" id="screen-news">
      <div class="page-content">
        <div class="section-header">
          <div class="section-title">Market Intelligence</div>
          <button onclick="renderNews()" style="background:none;border:1px solid var(--border);border-radius:var(--radius-xs);cursor:pointer;color:var(--text3);font-size:12px;padding:4px 10px;font-family:var(--font)">â†» Refresh</button>
        </div>
      </div>
      <div id="news-container"></div>
    </div>

  </div><!-- end screen-container -->

  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-home" onclick="navigate('home')">
      <div class="tab-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12L12 4l9 8"/><path d="M5 10v9a1 1 0 001 1h4v-5h4v5h4a1 1 0 001-1v-9"/>
        </svg>
      </div>
      <div class="tab-label">Portfolio</div>
    </button>
    <button class="tab-btn" id="tab-detail" onclick="navigate('detail')">
      <div class="tab-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/>
        </svg>
      </div>
      <div class="tab-label" id="tab-detail-label">Stock</div>
    </button>
    <button class="tab-btn" id="tab-history" onclick="navigate('history')">
      <div class="tab-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/>
        </svg>
      </div>
      <div class="tab-label">History</div>
    </button>
    <button class="tab-btn" id="tab-news" onclick="navigate('news')">
      <div class="tab-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>
        </svg>
      </div>
      <div class="tab-label">News</div>
    </button>
    <button class="tab-btn" id="tab-settings" onclick="navigate('settings')">
      <div class="tab-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 2v2m0 16v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M2 12h2m16 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
      </div>
      <div class="tab-label">Settings</div>
    </button>
  </div>
</div>

<!-- ADD TRANSACTION MODAL -->
<div class="modal-overlay" id="add-modal-overlay" onclick="closeModalOnOverlay(event,'add-modal-overlay')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="add-modal-title">Add Transaction</div>
    <div class="form-type-toggle">
      <button class="type-btn buy active" id="type-buy" onclick="setTxType('buy')">ðŸ“ˆ Buy</button>
      <button class="type-btn sell" id="type-sell" onclick="setTxType('sell')">ðŸ“‰ Sell</button>
    </div>
    <div class="form-group">
      <label class="form-label">Ticker Symbol</label>
      <div class="autocomplete-wrap">
        <input class="form-input" id="tx-ticker" placeholder="e.g. AAPL" autocomplete="off" autocapitalize="characters"
          oninput="onTickerInput(this.value)" onfocus="onTickerInput(this.value)">
        <div class="autocomplete-list" id="autocomplete-list"></div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Shares</label>
        <input class="form-input" id="tx-shares" type="number" placeholder="0" min="0" step="any" inputmode="decimal">
      </div>
      <div class="form-group">
        <label class="form-label">Price / Share</label>
        <input class="form-input" id="tx-price" type="number" placeholder="0.00" min="0" step="any" inputmode="decimal">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input class="form-input" id="tx-date" type="date">
    </div>
    <div id="tx-total-preview" style="background:var(--bg);border-radius:8px;padding:10px 14px;margin-bottom:4px;font-size:13px;color:var(--text2);display:none">
      Total: <strong id="tx-total-val"></strong>
    </div>
    <button class="btn-primary" id="save-tx-btn" onclick="saveTransaction()">Save Transaction</button>
    <button class="btn-secondary" onclick="closeModal('add-modal-overlay')">Cancel</button>
  </div>
</div>

<!-- EDIT TRANSACTION MODAL -->
<div class="modal-overlay" id="edit-modal-overlay" onclick="closeModalOnOverlay(event,'edit-modal-overlay')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Edit Transaction</div>
    <input type="hidden" id="edit-tx-id">
    <div class="form-type-toggle">
      <button class="type-btn buy" id="edit-type-buy" onclick="setEditTxType('buy')">ðŸ“ˆ Buy</button>
      <button class="type-btn sell" id="edit-type-sell" onclick="setEditTxType('sell')">ðŸ“‰ Sell</button>
    </div>
    <div class="form-group">
      <label class="form-label">Ticker Symbol</label>
      <input class="form-input" id="edit-ticker" readonly style="background:var(--surface2);color:var(--text3)">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Shares</label>
        <input class="form-input" id="edit-shares" type="number" placeholder="0" min="0" step="any" inputmode="decimal">
      </div>
      <div class="form-group">
        <label class="form-label">Price / Share</label>
        <input class="form-input" id="edit-price" type="number" placeholder="0.00" min="0" step="any" inputmode="decimal">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input class="form-input" id="edit-date" type="date">
    </div>
    <button class="btn-primary" onclick="saveEditTransaction()">Save Changes</button>
    <button class="btn-secondary btn-danger" onclick="confirmDeleteTransaction()">Delete Transaction</button>
    <button class="btn-secondary" onclick="closeModal('edit-modal-overlay')">Cancel</button>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title" id="confirm-title">Are you sure?</div>
    <div class="confirm-msg" id="confirm-msg"></div>
    <div class="confirm-actions">
      <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-ok" id="confirm-ok-btn" onclick="runConfirm()">Confirm</button>
    </div>
  </div>
</div>

<!-- CHART TOOLTIP -->

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCK DATABASE â€” 500+ tickers (S&P 500, popular ETFs, crypto ETFs)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STOCK_DB = [
  // Mega-cap / most traded
  {t:'AAPL',n:'Apple Inc.'},{t:'MSFT',n:'Microsoft Corporation'},{t:'NVDA',n:'NVIDIA Corporation'},
  {t:'GOOGL',n:'Alphabet Inc. (Class A)'},{t:'GOOG',n:'Alphabet Inc. (Class C)'},{t:'AMZN',n:'Amazon.com Inc.'},
  {t:'META',n:'Meta Platforms Inc.'},{t:'TSLA',n:'Tesla Inc.'},{t:'BRK.B',n:'Berkshire Hathaway Inc.'},
  {t:'BRK.A',n:'Berkshire Hathaway Inc. (A)'},{t:'LLY',n:'Eli Lilly and Company'},{t:'JPM',n:'JPMorgan Chase & Co.'},
  {t:'V',n:'Visa Inc.'},{t:'XOM',n:'Exxon Mobil Corporation'},{t:'UNH',n:'UnitedHealth Group Inc.'},
  {t:'AVGO',n:'Broadcom Inc.'},{t:'MA',n:'Mastercard Inc.'},{t:'JNJ',n:'Johnson & Johnson'},
  {t:'PG',n:'Procter & Gamble Co.'},{t:'HD',n:'The Home Depot Inc.'},{t:'COST',n:'Costco Wholesale Corporation'},
  {t:'MRK',n:'Merck & Co. Inc.'},{t:'ABBV',n:'AbbVie Inc.'},{t:'CVX',n:'Chevron Corporation'},
  {t:'ORCL',n:'Oracle Corporation'},{t:'AMD',n:'Advanced Micro Devices Inc.'},{t:'NFLX',n:'Netflix Inc.'},
  {t:'ADBE',n:'Adobe Inc.'},{t:'CRM',n:'Salesforce Inc.'},{t:'WMT',n:'Walmart Inc.'},
  // Tech
  {t:'INTC',n:'Intel Corporation'},{t:'QCOM',n:'Qualcomm Inc.'},{t:'TXN',n:'Texas Instruments Inc.'},
  {t:'INTU',n:'Intuit Inc.'},{t:'IBM',n:'International Business Machines'},{t:'AMAT',n:'Applied Materials Inc.'},
  {t:'MU',n:'Micron Technology Inc.'},{t:'LRCX',n:'Lam Research Corporation'},{t:'KLAC',n:'KLA Corporation'},
  {t:'MRVL',n:'Marvell Technology Inc.'},{t:'SNPS',n:'Synopsys Inc.'},{t:'CDNS',n:'Cadence Design Systems'},
  {t:'FTNT',n:'Fortinet Inc.'},{t:'PANW',n:'Palo Alto Networks Inc.'},{t:'CRWD',n:'CrowdStrike Holdings'},
  {t:'ZS',n:'Zscaler Inc.'},{t:'OKTA',n:'Okta Inc.'},{t:'DDOG',n:'Datadog Inc.'},
  {t:'SNOW',n:'Snowflake Inc.'},{t:'MDB',n:'MongoDB Inc.'},{t:'NET',n:'Cloudflare Inc.'},
  {t:'TWLO',n:'Twilio Inc.'},{t:'SHOP',n:'Shopify Inc.'},{t:'HUBS',n:'HubSpot Inc.'},
  {t:'TEAM',n:'Atlassian Corporation'},{t:'WDAY',n:'Workday Inc.'},{t:'NOW',n:'ServiceNow Inc.'},
  {t:'VEEV',n:'Veeva Systems Inc.'},{t:'ZM',n:'Zoom Video Communications'},{t:'DOCU',n:'DocuSign Inc.'},
  {t:'ESTC',n:'Elastic N.V.'},{t:'GTLB',n:'GitLab Inc.'},{t:'PATH',n:'UiPath Inc.'},
  {t:'AI',n:'C3.ai Inc.'},{t:'BBAI',n:'BigBear.ai Holdings'},{t:'SOUN',n:'SoundHound AI'},
  {t:'IONQ',n:'IonQ Inc.'},{t:'RGTI',n:'Rigetti Computing'},{t:'QUBT',n:'Quantum Computing Inc.'},
  {t:'MSCI',n:'MSCI Inc.'},{t:'ANSS',n:'Ansys Inc.'},{t:'PTC',n:'PTC Inc.'},
  {t:'EPAM',n:'EPAM Systems Inc.'},{t:'CTSH',n:'Cognizant Technology Solutions'},{t:'ACN',n:'Accenture plc'},
  {t:'WIT',n:'Wipro Limited'},{t:'INFY',n:'Infosys Limited'},{t:'HCL',n:'HCL Technologies'},
  // Semiconductors
  {t:'TSM',n:'Taiwan Semiconductor Manufacturing'},{t:'ASML',n:'ASML Holding N.V.'},
  {t:'ADI',n:'Analog Devices Inc.'},{t:'NXPI',n:'NXP Semiconductors N.V.'},
  {t:'MCHP',n:'Microchip Technology Inc.'},{t:'ON',n:'ON Semiconductor Corporation'},
  {t:'WOLF',n:'Wolfspeed Inc.'},{t:'SWKS',n:'Skyworks Solutions Inc.'},
  {t:'QRVO',n:'Qorvo Inc.'},{t:'MPWR',n:'Monolithic Power Systems'},
  {t:'SMCI',n:'Super Micro Computer Inc.'},{t:'DELL',n:'Dell Technologies Inc.'},
  {t:'HPQ',n:'HP Inc.'},{t:'HPE',n:'Hewlett Packard Enterprise'},
  {t:'STX',n:'Seagate Technology Holdings'},{t:'WDC',n:'Western Digital Corporation'},
  // Communication
  {t:'T',n:'AT&T Inc.'},{t:'VZ',n:'Verizon Communications Inc.'},{t:'TMUS',n:'T-Mobile US Inc.'},
  {t:'CHTR',n:'Charter Communications Inc.'},{t:'CMCSA',n:'Comcast Corporation'},
  {t:'DIS',n:'The Walt Disney Company'},{t:'PARA',n:'Paramount Global'},
  {t:'WBD',n:'Warner Bros. Discovery'},{t:'NWSA',n:'News Corp (Class A)'},
  {t:'FOX',n:'Fox Corporation (Class B)'},{t:'FOXA',n:'Fox Corporation (Class A)'},
  {t:'SIRI',n:'Sirius XM Holdings Inc.'},{t:'SPOT',n:'Spotify Technology SA'},
  {t:'SNAP',n:'Snap Inc.'},{t:'PINS',n:'Pinterest Inc.'},{t:'RDDT',n:'Reddit Inc.'},
  {t:'MTCH',n:'Match Group Inc.'},{t:'IAC',n:'IAC Inc.'},{t:'ZG',n:'Zillow Group Inc.'},
  // Financials
  {t:'GS',n:'Goldman Sachs Group Inc.'},{t:'MS',n:'Morgan Stanley'},{t:'BAC',n:'Bank of America Corporation'},
  {t:'WFC',n:'Wells Fargo & Company'},{t:'C',n:'Citigroup Inc.'},{t:'USB',n:'U.S. Bancorp'},
  {t:'PNC',n:'PNC Financial Services Group'},{t:'TFC',n:'Truist Financial Corporation'},
  {t:'COF',n:'Capital One Financial Corporation'},{t:'AXP',n:'American Express Company'},
  {t:'DFS',n:'Discover Financial Services'},{t:'SYF',n:'Synchrony Financial'},
  {t:'BK',n:'Bank of New York Mellon'},{t:'STT',n:'State Street Corporation'},
  {t:'SCHW',n:'Charles Schwab Corporation'},{t:'RJF',n:'Raymond James Financial'},
  {t:'IVZ',n:'Invesco Ltd.'},{t:'BLK',n:'BlackRock Inc.'},{t:'BX',n:'Blackstone Inc.'},
  {t:'KKR',n:'KKR & Co. Inc.'},{t:'APO',n:'Apollo Global Management'},
  {t:'ARES',n:'Ares Management Corporation'},{t:'CG',n:'Carlyle Group Inc.'},
  {t:'BAM',n:'Brookfield Asset Management'},{t:'TROW',n:'T. Rowe Price Group'},
  {t:'AMP',n:'Ameriprise Financial Inc.'},{t:'LNC',n:'Lincoln National Corporation'},
  {t:'PRU',n:'Prudential Financial Inc.'},{t:'MET',n:'MetLife Inc.'},
  {t:'AFL',n:'Aflac Incorporated'},{t:'AIG',n:'American International Group'},
  {t:'TRV',n:'The Travelers Companies Inc.'},{t:'PGR',n:'Progressive Corporation'},
  {t:'ALL',n:'Allstate Corporation'},{t:'CB',n:'Chubb Limited'},
  {t:'MMC',n:'Marsh & McLennan Companies'},{t:'AON',n:'Aon plc'},
  {t:'WTW',n:'Willis Towers Watson'},{t:'SPGI',n:'S&P Global Inc.'},
  {t:'MCO',n:'Moody\'s Corporation'},{t:'ICE',n:'Intercontinental Exchange'},
  {t:'CME',n:'CME Group Inc.'},{t:'NDAQ',n:'Nasdaq Inc.'},{t:'CBOE',n:'Cboe Global Markets'},
  {t:'PYPL',n:'PayPal Holdings Inc.'},{t:'SQ',n:'Block Inc.'},{t:'AFRM',n:'Affirm Holdings Inc.'},
  {t:'SOFI',n:'SoFi Technologies Inc.'},{t:'UPST',n:'Upstart Holdings Inc.'},
  {t:'LC',n:'LendingClub Corporation'},{t:'GPN',n:'Global Payments Inc.'},
  {t:'FIS',n:'Fidelity National Information Services'},{t:'FI',n:'Fiserv Inc.'},
  {t:'V',n:'Visa Inc.'},{t:'MA',n:'Mastercard Inc.'},
  // Healthcare
  {t:'PFE',n:'Pfizer Inc.'},{t:'BMY',n:'Bristol-Myers Squibb Company'},
  {t:'GILD',n:'Gilead Sciences Inc.'},{t:'AMGN',n:'Amgen Inc.'},
  {t:'BIIB',n:'Biogen Inc.'},{t:'VRTX',n:'Vertex Pharmaceuticals'},
  {t:'REGN',n:'Regeneron Pharmaceuticals'},{t:'MRNA',n:'Moderna Inc.'},
  {t:'BNTX',n:'BioNTech SE'},{t:'AZN',n:'AstraZeneca plc'},
  {t:'NVO',n:'Novo Nordisk A/S'},{t:'SNY',n:'Sanofi SA'},
  {t:'NVS',n:'Novartis AG'},{t:'RHHBY',n:'Roche Holding AG'},
  {t:'ABT',n:'Abbott Laboratories'},{t:'MDT',n:'Medtronic plc'},
  {t:'BSX',n:'Boston Scientific Corporation'},{t:'SYK',n:'Stryker Corporation'},
  {t:'EW',n:'Edwards Lifesciences Corporation'},{t:'ISRG',n:'Intuitive Surgical Inc.'},
  {t:'DXCM',n:'DexCom Inc.'},{t:'PODD',n:'Insulet Corporation'},
  {t:'HOLX',n:'Hologic Inc.'},{t:'BDX',n:'Becton Dickinson and Company'},
  {t:'BAX',n:'Baxter International Inc.'},{t:'ZBH',n:'Zimmer Biomet Holdings'},
  {t:'ALGN',n:'Align Technology Inc.'},{t:'IDXX',n:'IDEXX Laboratories Inc.'},
  {t:'IQV',n:'IQVIA Holdings Inc.'},{t:'CRL',n:'Charles River Laboratories'},
  {t:'TMO',n:'Thermo Fisher Scientific Inc.'},{t:'DHR',n:'Danaher Corporation'},
  {t:'A',n:'Agilent Technologies Inc.'},{t:'MTD',n:'Mettler-Toledo International'},
  {t:'WAT',n:'Waters Corporation'},{t:'TECH',n:'Bio-Techne Corporation'},
  {t:'ILMN',n:'Illumina Inc.'},{t:'PACB',n:'Pacific Biosciences'},
  {t:'CVS',n:'CVS Health Corporation'},{t:'MCK',n:'McKesson Corporation'},
  {t:'ABC',n:'AmerisourceBergen Corporation'},{t:'CAH',n:'Cardinal Health Inc.'},
  {t:'HCA',n:'HCA Healthcare Inc.'},{t:'THC',n:'Tenet Healthcare Corporation'},
  {t:'CNC',n:'Centene Corporation'},{t:'MOH',n:'Molina Healthcare Inc.'},
  {t:'HUM',n:'Humana Inc.'},{t:'CI',n:'Cigna Group'},
  {t:'ELV',n:'Elevance Health Inc.'},{t:'UNH',n:'UnitedHealth Group Inc.'},
  // Consumer Discretionary
  {t:'AMZN',n:'Amazon.com Inc.'},{t:'TSLA',n:'Tesla Inc.'},
  {t:'HD',n:'The Home Depot Inc.'},{t:'LOW',n:'Lowe\'s Companies Inc.'},
  {t:'NKE',n:'Nike Inc.'},{t:'LULU',n:'Lululemon Athletica Inc.'},
  {t:'DECK',n:'Deckers Outdoor Corporation'},{t:'SKX',n:'Skechers U.S.A. Inc.'},
  {t:'PVH',n:'PVH Corp.'},{t:'RL',n:'Ralph Lauren Corporation'},
  {t:'TPR',n:'Tapestry Inc.'},{t:'CPRI',n:'Capri Holdings Limited'},
  {t:'MCD',n:'McDonald\'s Corporation'},{t:'SBUX',n:'Starbucks Corporation'},
  {t:'CMG',n:'Chipotle Mexican Grill Inc.'},{t:'YUM',n:'Yum! Brands Inc.'},
  {t:'DPZ',n:'Domino\'s Pizza Inc.'},{t:'QSR',n:'Restaurant Brands International'},
  {t:'DKNG',n:'DraftKings Inc.'},{t:'MGM',n:'MGM Resorts International'},
  {t:'WYNN',n:'Wynn Resorts Limited'},{t:'LVS',n:'Las Vegas Sands Corp.'},
  {t:'NCLH',n:'Norwegian Cruise Line Holdings'},{t:'CCL',n:'Carnival Corporation'},
  {t:'RCL',n:'Royal Caribbean Cruises Ltd.'},{t:'EXPE',n:'Expedia Group Inc.'},
  {t:'BKNG',n:'Booking Holdings Inc.'},{t:'ABNB',n:'Airbnb Inc.'},
  {t:'UBER',n:'Uber Technologies Inc.'},{t:'LYFT',n:'Lyft Inc.'},
  {t:'DASH',n:'DoorDash Inc.'},{t:'GRUB',n:'Grubhub Inc.'},
  {t:'W',n:'Wayfair Inc.'},{t:'ETSY',n:'Etsy Inc.'},
  {t:'EBAY',n:'eBay Inc.'},{t:'RVLV',n:'Revolve Group Inc.'},
  {t:'TGT',n:'Target Corporation'},{t:'WMT',n:'Walmart Inc.'},
  {t:'COST',n:'Costco Wholesale Corporation'},{t:'BJ',n:'BJ\'s Wholesale Club Holdings'},
  {t:'DG',n:'Dollar General Corporation'},{t:'DLTR',n:'Dollar Tree Inc.'},
  {t:'FIVE',n:'Five Below Inc.'},{t:'OLLI',n:'Ollie\'s Bargain Outlet Holdings'},
  {t:'TJX',n:'TJX Companies Inc.'},{t:'ROST',n:'Ross Stores Inc.'},
  {t:'GPS',n:'Gap Inc.'},{t:'ANF',n:'Abercrombie & Fitch Co.'},
  {t:'AEO',n:'American Eagle Outfitters'},{t:'FL',n:'Foot Locker Inc.'},
  {t:'KSS',n:'Kohl\'s Corporation'},{t:'JWN',n:'Nordstrom Inc.'},
  {t:'M',n:'Macy\'s Inc.'},{t:'AMZN',n:'Amazon.com Inc.'},
  // Consumer Staples
  {t:'PG',n:'Procter & Gamble Co.'},{t:'KO',n:'The Coca-Cola Company'},
  {t:'PEP',n:'PepsiCo Inc.'},{t:'PM',n:'Philip Morris International'},
  {t:'MO',n:'Altria Group Inc.'},{t:'BTI',n:'British American Tobacco plc'},
  {t:'CL',n:'Colgate-Palmolive Company'},{t:'KMB',n:'Kimberly-Clark Corporation'},
  {t:'CHD',n:'Church & Dwight Co. Inc.'},{t:'ENR',n:'Energizer Holdings Inc.'},
  {t:'EL',n:'EstÃ©e Lauder Companies Inc.'},{t:'COTY',n:'Coty Inc.'},
  {t:'UN',n:'Unilever plc'},{t:'NSRGY',n:'NestlÃ© SA'},
  {t:'GIS',n:'General Mills Inc.'},{t:'K',n:'Kellanova'},
  {t:'CPB',n:'Campbell Soup Company'},{t:'HRL',n:'Hormel Foods Corporation'},
  {t:'SJM',n:'J.M. Smucker Company'},{t:'MKC',n:'McCormick & Company'},
  {t:'HSY',n:'The Hershey Company'},{t:'MDLZ',n:'Mondelez International'},
  {t:'CAG',n:'Conagra Brands Inc.'},{t:'FRPT',n:'Freshpet Inc.'},
  {t:'BYND',n:'Beyond Meat Inc.'},{t:'KR',n:'The Kroger Co.'},
  {t:'SFM',n:'Sprouts Farmers Market Inc.'},{t:'GO',n:'Grocery Outlet Holding Corp.'},
  {t:'USFD',n:'US Foods Holding Corp.'},{t:'SYY',n:'Sysco Corporation'},
  // Energy
  {t:'XOM',n:'Exxon Mobil Corporation'},{t:'CVX',n:'Chevron Corporation'},
  {t:'COP',n:'ConocoPhillips'},{t:'EOG',n:'EOG Resources Inc.'},
  {t:'PXD',n:'Pioneer Natural Resources'},{t:'DVN',n:'Devon Energy Corporation'},
  {t:'FANG',n:'Diamondback Energy Inc.'},{t:'MPC',n:'Marathon Petroleum Corporation'},
  {t:'VLO',n:'Valero Energy Corporation'},{t:'PSX',n:'Phillips 66'},
  {t:'HES',n:'Hess Corporation'},{t:'APA',n:'APA Corporation'},
  {t:'HAL',n:'Halliburton Company'},{t:'SLB',n:'SLB (Schlumberger)'},
  {t:'BKR',n:'Baker Hughes Company'},{t:'NOV',n:'NOV Inc.'},
  {t:'OXY',n:'Occidental Petroleum Corporation'},{t:'OKE',n:'ONEOK Inc.'},
  {t:'WMB',n:'Williams Companies Inc.'},{t:'ET',n:'Energy Transfer LP'},
  {t:'KMI',n:'Kinder Morgan Inc.'},{t:'EPD',n:'Enterprise Products Partners'},
  {t:'MPLX',n:'MPLX LP'},{t:'LNG',n:'Cheniere Energy Inc.'},
  {t:'AR',n:'Antero Resources Corporation'},{t:'EQT',n:'EQT Corporation'},
  {t:'RRC',n:'Range Resources Corporation'},{t:'CNX',n:'CNX Resources Corporation'},
  // Industrials
  {t:'CAT',n:'Caterpillar Inc.'},{t:'DE',n:'Deere & Company'},
  {t:'BA',n:'Boeing Company'},{t:'RTX',n:'RTX Corporation'},
  {t:'LMT',n:'Lockheed Martin Corporation'},{t:'NOC',n:'Northrop Grumman Corporation'},
  {t:'GD',n:'General Dynamics Corporation'},{t:'L3H',n:'L3Harris Technologies'},
  {t:'GE',n:'GE Aerospace'},{t:'HON',n:'Honeywell International Inc.'},
  {t:'MMM',n:'3M Company'},{t:'EMR',n:'Emerson Electric Co.'},
  {t:'ETN',n:'Eaton Corporation plc'},{t:'ROK',n:'Rockwell Automation Inc.'},
  {t:'PH',n:'Parker-Hannifin Corporation'},{t:'DOV',n:'Dover Corporation'},
  {t:'ITW',n:'Illinois Tool Works Inc.'},{t:'XYL',n:'Xylem Inc.'},
  {t:'GNRC',n:'Generac Holdings Inc.'},{t:'AIXI',n:'Xiao-I Corporation'},
  {t:'UPS',n:'United Parcel Service Inc.'},{t:'FDX',n:'FedEx Corporation'},
  {t:'CHRW',n:'C.H. Robinson Worldwide Inc.'},{t:'EXPD',n:'Expeditors International'},
  {t:'JBHT',n:'J.B. Hunt Transport Services'},{t:'ODFL',n:'Old Dominion Freight Line'},
  {t:'XPO',n:'XPO Inc.'},{t:'SAIA',n:'Saia Inc.'},
  {t:'CSX',n:'CSX Corporation'},{t:'NSC',n:'Norfolk Southern Corporation'},
  {t:'UNP',n:'Union Pacific Corporation'},{t:'BNSF',n:'Burlington Northern Santa Fe'},
  {t:'DAL',n:'Delta Air Lines Inc.'},{t:'UAL',n:'United Airlines Holdings'},
  {t:'AAL',n:'American Airlines Group Inc.'},{t:'LUV',n:'Southwest Airlines Co.'},
  {t:'ALK',n:'Alaska Air Group Inc.'},{t:'SAVE',n:'Spirit Airlines Inc.'},
  {t:'R',n:'Ryder System Inc.'},{t:'ALLE',n:'Allegion plc'},
  {t:'IR',n:'Ingersoll Rand Inc.'},{t:'TT',n:'Trane Technologies plc'},
  {t:'CARR',n:'Carrier Global Corporation'},{t:'OTIS',n:'Otis Worldwide Corporation'},
  {t:'AME',n:'AMETEK Inc.'},{t:'ROP',n:'Roper Technologies Inc.'},
  {t:'FTV',n:'Fortive Corporation'},{t:'DHI',n:'D.R. Horton Inc.'},
  {t:'LEN',n:'Lennar Corporation'},{t:'NVR',n:'NVR Inc.'},
  {t:'TOL',n:'Toll Brothers Inc.'},{t:'MDC',n:'MDC Holdings Inc.'},
  // Materials
  {t:'LIN',n:'Linde plc'},{t:'APD',n:'Air Products and Chemicals Inc.'},
  {t:'FCX',n:'Freeport-McMoRan Inc.'},{t:'NEM',n:'Newmont Corporation'},
  {t:'NUE',n:'Nucor Corporation'},{t:'STLD',n:'Steel Dynamics Inc.'},
  {t:'RS',n:'Reliance Steel & Aluminum'},{t:'CLF',n:'Cleveland-Cliffs Inc.'},
  {t:'CF',n:'CF Industries Holdings Inc.'},{t:'MOS',n:'The Mosaic Company'},
  {t:'FMC',n:'FMC Corporation'},{t:'ECL',n:'Ecolab Inc.'},
  {t:'PPG',n:'PPG Industries Inc.'},{t:'SHW',n:'Sherwin-Williams Company'},
  {t:'RPM',n:'RPM International Inc.'},{t:'IFF',n:'International Flavors & Fragrances'},
  {t:'ALB',n:'Albemarle Corporation'},{t:'LTHM',n:'Livent Corporation'},
  {t:'LAC',n:'Lithium Americas Corp.'},{t:'PLL',n:'Piedmont Lithium Inc.'},
  // Real Estate / REITs
  {t:'AMT',n:'American Tower Corporation'},{t:'PLD',n:'Prologis Inc.'},
  {t:'CCI',n:'Crown Castle Inc.'},{t:'EQIX',n:'Equinix Inc.'},
  {t:'PSA',n:'Public Storage'},{t:'EXR',n:'Extra Space Storage Inc.'},
  {t:'AVB',n:'AvalonBay Communities Inc.'},{t:'EQR',n:'Equity Residential'},
  {t:'MAA',n:'Mid-America Apartment Communities'},{t:'UDR',n:'UDR Inc.'},
  {t:'SPG',n:'Simon Property Group Inc.'},{t:'O',n:'Realty Income Corporation'},
  {t:'WPC',n:'W. P. Carey Inc.'},{t:'NNN',n:'NNN REIT Inc.'},
  {t:'STOR',n:'STORE Capital Corporation'},{t:'VICI',n:'VICI Properties Inc.'},
  {t:'GLPI',n:'Gaming and Leisure Properties'},{t:'LADR',n:'Ladder Capital Corp.'},
  {t:'WELL',n:'Welltower Inc.'},{t:'VTR',n:'Ventas Inc.'},
  {t:'HR',n:'Healthcare Realty Trust'},{t:'MPW',n:'Medical Properties Trust'},
  {t:'ARE',n:'Alexandria Real Estate Equities'},{t:'BXP',n:'BXP Inc.'},
  {t:'VNO',n:'Vornado Realty Trust'},{t:'KIM',n:'Kimco Realty Corporation'},
  {t:'REG',n:'Regency Centers Corporation'},{t:'FRT',n:'Federal Realty Investment Trust'},
  {t:'DLR',n:'Digital Realty Trust Inc.'},{t:'SBAC',n:'SBA Communications Corporation'},
  // Utilities
  {t:'NEE',n:'NextEra Energy Inc.'},{t:'DUK',n:'Duke Energy Corporation'},
  {t:'SO',n:'Southern Company'},{t:'D',n:'Dominion Energy Inc.'},
  {t:'AEP',n:'American Electric Power'},{t:'EXC',n:'Exelon Corporation'},
  {t:'PCG',n:'PG&E Corporation'},{t:'ED',n:'Consolidated Edison Inc.'},
  {t:'ES',n:'Eversource Energy'},{t:'XEL',n:'Xcel Energy Inc.'},
  {t:'WEC',n:'WEC Energy Group Inc.'},{t:'DTE',n:'DTE Energy Company'},
  {t:'CMS',n:'CMS Energy Corporation'},{t:'AES',n:'AES Corporation'},
  {t:'AWK',n:'American Water Works Company'},{t:'WTR',n:'Artesian Resources Corporation'},
  // Popular ETFs
  {t:'SPY',n:'SPDR S&P 500 ETF Trust'},{t:'IVV',n:'iShares Core S&P 500 ETF'},
  {t:'VOO',n:'Vanguard S&P 500 ETF'},{t:'VTI',n:'Vanguard Total Stock Market ETF'},
  {t:'QQQ',n:'Invesco QQQ Trust (Nasdaq-100)'},{t:'QQQM',n:'Invesco Nasdaq-100 ETF'},
  {t:'IWM',n:'iShares Russell 2000 ETF'},{t:'IWF',n:'iShares Russell 1000 Growth ETF'},
  {t:'VGT',n:'Vanguard Information Technology ETF'},{t:'XLK',n:'Technology Select Sector SPDR'},
  {t:'XLF',n:'Financial Select Sector SPDR'},{t:'XLE',n:'Energy Select Sector SPDR'},
  {t:'XLV',n:'Health Care Select Sector SPDR'},{t:'XLI',n:'Industrial Select Sector SPDR'},
  {t:'XLC',n:'Communication Services Select Sector SPDR'},{t:'XLY',n:'Consumer Discretionary Select Sector SPDR'},
  {t:'XLP',n:'Consumer Staples Select Sector SPDR'},{t:'XLU',n:'Utilities Select Sector SPDR'},
  {t:'XLB',n:'Materials Select Sector SPDR'},{t:'XLRE',n:'Real Estate Select Sector SPDR'},
  {t:'ARKK',n:'ARK Innovation ETF'},{t:'ARKQ',n:'ARK Autonomous Tech & Robotics ETF'},
  {t:'ARKW',n:'ARK Next Generation Internet ETF'},{t:'ARKG',n:'ARK Genomic Revolution ETF'},
  {t:'ARKF',n:'ARK Fintech Innovation ETF'},{t:'ARKX',n:'ARK Space Exploration ETF'},
  {t:'GLD',n:'SPDR Gold Shares'},{t:'IAU',n:'iShares Gold Trust'},
  {t:'SLV',n:'iShares Silver Trust'},{t:'GDX',n:'VanEck Gold Miners ETF'},
  {t:'GDXJ',n:'VanEck Junior Gold Miners ETF'},{t:'USO',n:'United States Oil Fund'},
  {t:'DBO',n:'Invesco DB Oil Fund'},{t:'TLT',n:'iShares 20+ Year Treasury Bond ETF'},
  {t:'IEF',n:'iShares 7-10 Year Treasury Bond ETF'},{t:'HYG',n:'iShares iBoxx High Yield Corporate Bond ETF'},
  {t:'LQD',n:'iShares iBoxx Investment Grade Corporate Bond ETF'},{t:'AGG',n:'iShares Core U.S. Aggregate Bond ETF'},
  {t:'BND',n:'Vanguard Total Bond Market ETF'},{t:'BITO',n:'ProShares Bitcoin Strategy ETF'},
  {t:'IBIT',n:'iShares Bitcoin Trust ETF'},{t:'FBTC',n:'Fidelity Wise Origin Bitcoin Fund'},
  {t:'GBTC',n:'Grayscale Bitcoin Trust'},{t:'ETHE',n:'Grayscale Ethereum Trust'},
  {t:'MSOS',n:'AdvisorShares Pure US Cannabis ETF'},{t:'MJ',n:'ETFMG Alternative Harvest ETF'},
  {t:'BOTZ',n:'Global X Robotics & Artificial Intelligence ETF'},{t:'ROBO',n:'ROBO Global Robotics and Automation ETF'},
  {t:'SOXX',n:'iShares Semiconductor ETF'},{t:'SMH',n:'VanEck Semiconductor ETF'},
  {t:'FINX',n:'Global X FinTech ETF'},{t:'CIBR',n:'First Trust NASDAQ Cybersecurity ETF'},
  {t:'HACK',n:'ETFMG Prime Cyber Security ETF'},{t:'SKYY',n:'First Trust Cloud Computing ETF'},
  {t:'WCLD',n:'WisdomTree Cloud Computing Fund'},{t:'CLOU',n:'Global X Cloud Computing ETF'},
  {t:'SOXS',n:'Direxion Daily Semiconductor Bear 3X Shares'},{t:'SOXL',n:'Direxion Daily Semiconductor Bull 3X Shares'},
  {t:'TQQQ',n:'ProShares UltraPro QQQ'},{t:'SQQQ',n:'ProShares UltraPro Short QQQ'},
  {t:'UPRO',n:'ProShares UltraPro S&P 500'},{t:'SPXS',n:'Direxion Daily S&P 500 Bear 3X'},
  {t:'SPXU',n:'ProShares UltraPro Short S&P 500'},{t:'UVXY',n:'ProShares Ultra VIX Short-Term Futures ETF'},
  {t:'VXX',n:'iPath Series B S&P 500 VIX Short-Term Futures ETN'},
  {t:'VIXY',n:'ProShares VIX Short-Term Futures ETF'},{t:'RSP',n:'Invesco S&P 500 Equal Weight ETF'},
  {t:'VEA',n:'Vanguard FTSE Developed Markets ETF'},{t:'VWO',n:'Vanguard FTSE Emerging Markets ETF'},
  {t:'EEM',n:'iShares MSCI Emerging Markets ETF'},{t:'EFA',n:'iShares MSCI EAFE ETF'},
  {t:'FXI',n:'iShares China Large-Cap ETF'},{t:'KWEB',n:'KraneShares CSI China Internet ETF'},
  {t:'EWZ',n:'iShares MSCI Brazil ETF'},{t:'EWJ',n:'iShares MSCI Japan ETF'},
  // Popular individual stocks continued
  {t:'COIN',n:'Coinbase Global Inc.'},{t:'HOOD',n:'Robinhood Markets Inc.'},
  {t:'MSTR',n:'MicroStrategy Incorporated'},{t:'MARA',n:'MARA Holdings Inc.'},
  {t:'RIOT',n:'Riot Platforms Inc.'},{t:'CLSK',n:'CleanSpark Inc.'},
  {t:'HUT',n:'Hut 8 Corp.'},{t:'BTBT',n:'Bit Digital Inc.'},
  {t:'PLTR',n:'Palantir Technologies Inc.'},{t:'RBLX',n:'Roblox Corporation'},
  {t:'RIVN',n:'Rivian Automotive Inc.'},{t:'LCID',n:'Lucid Group Inc.'},
  {t:'NIO',n:'NIO Inc.'},{t:'LI',n:'Li Auto Inc.'},
  {t:'XPEV',n:'XPeng Inc.'},{t:'F',n:'Ford Motor Company'},
  {t:'GM',n:'General Motors Company'},{t:'STLA',n:'Stellantis N.V.'},
  {t:'TM',n:'Toyota Motor Corporation'},{t:'HMC',n:'Honda Motor Co. Ltd.'},
  {t:'RACE',n:'Ferrari N.V.'},{t:'BMWYY',n:'BMW AG'},
  {t:'VWAGY',n:'Volkswagen AG'},{t:'MBGYY',n:'Mercedes-Benz Group AG'},
  {t:'RKT',n:'Rocket Companies Inc.'},{t:'OPEN',n:'Opendoor Technologies Inc.'},
  {t:'COMP',n:'Compass Inc.'},{t:'Z',n:'Zillow Group Inc. (Class C)'},
  {t:'RDFN',n:'Redfin Corporation'},{t:'HOUS',n:'Anywhere Real Estate Inc.'},
  {t:'SPCE',n:'Virgin Galactic Holdings'},{t:'RDW',n:'Redwire Corporation'},
  {t:'RKLB',n:'Rocket Lab USA Inc.'},{t:'ASTS',n:'AST SpaceMobile Inc.'},
  {t:'LUNR',n:'Intuitive Machines Inc.'},{t:'MNTS',n:'Momentus Inc.'},
  {t:'JOBY',n:'Joby Aviation Inc.'},{t:'ACHR',n:'Archer Aviation Inc.'},
  {t:'LILM',n:'Lilium N.V.'},{t:'EVTOL',n:'Eve Holding Inc.'},
  {t:'ENVX',n:'Enovix Corporation'},{t:'QS',n:'QuantumScape Corporation'},
  {t:'STEM',n:'Stem Inc.'},{t:'FSLR',n:'First Solar Inc.'},
  {t:'ENPH',n:'Enphase Energy Inc.'},{t:'SEDG',n:'SolarEdge Technologies Inc.'},
  {t:'RUN',n:'Sunrun Inc.'},{t:'SPWR',n:'SunPower Corporation'},
  {t:'BE',n:'Bloom Energy Corporation'},{t:'PLUG',n:'Plug Power Inc.'},
  {t:'FCEL',n:'FuelCell Energy Inc.'},{t:'BLDP',n:'Ballard Power Systems'},
  {t:'NOVA',n:'Sunnova Energy International'},{t:'ARRY',n:'Array Technologies Inc.'},
  {t:'NEP',n:'NextEra Energy Partners LP'},{t:'BEP',n:'Brookfield Renewable Partners'},
  {t:'AY',n:'Atlantica Sustainable Infrastructure'},{t:'CWEN',n:'Clearway Energy Inc.'},
  {t:'ORA',n:'Ormat Technologies Inc.'},{t:'GPRE',n:'Green Plains Inc.'},
  // More popular names
  {t:'NKLA',n:'Nikola Corporation'},{t:'WKHS',n:'Workhorse Group Inc.'},
  {t:'FSR',n:'Fisker Inc.'},{t:'GOEV',n:'Canoo Inc.'},
  {t:'HYLN',n:'Hyliion Holdings Corp.'},{t:'REE',n:'REE Automotive Ltd.'},
  {t:'SOLO',n:'Electrameccanica Vehicles Corp.'},{t:'AYRO',n:'AYRO Inc.'},
  {t:'WBX',n:'Wallbox N.V.'},{t:'BLNK',n:'Blink Charging Co.'},
  {t:'EVGO',n:'EVgo Inc.'},{t:'CHPT',n:'ChargePoint Holdings Inc.'},
  {t:'VLTO',n:'Veralto Corporation'},{t:'GEHC',n:'GE HealthCare Technologies'},
  {t:'KVUE',n:'Kenvue Inc.'},{t:'SOLV',n:'Solventum Corporation'},
  {t:'GFS',n:'GlobalFoundries Inc.'},{t:'ARM',n:'Arm Holdings plc'},
  {t:'BIRK',n:'Birkenstock Holding plc'},{t:'CART',n:'Instacart (Maplebear Inc.)'},
  {t:'KVYO',n:'Klaviyo Inc.'},{t:'ONON',n:'On Holding AG'},
  {t:'BIRK',n:'Birkenstock Holding plc'},{t:'CAVA',n:'CAVA Group Inc.'},
  {t:'SHAK',n:'Shake Shack Inc.'},{t:'TXRH',n:'Texas Roadhouse Inc.'},
  {t:'DINE',n:'Dine Brands Global Inc.'},{t:'EAT',n:'Brinker International Inc.'},
  {t:'DRI',n:'Darden Restaurants Inc.'},{t:'RUTH',n:'Ruth\'s Hospitality Group'},
  {t:'CAKE',n:'The Cheesecake Factory Incorporated'},{t:'BJRI',n:'BJ\'s Restaurants Inc.'},
  {t:'WING',n:'Wingstop Inc.'},{t:'NATH',n:'Nathan\'s Famous Inc.'},
  {t:'BROS',n:'Dutch Bros Inc.'},{t:'DNKN',n:'Dunkin\' Brands Group'},
  {t:'WEN',n:'Wendy\'s Company'},{t:'JACK',n:'Jack in the Box Inc.'},
  {t:'SONC',n:'Sonic Automotive Inc.'},{t:'AN',n:'AutoNation Inc.'},
  {t:'KMX',n:'CarMax Inc.'},{t:'CVNA',n:'Carvana Co.'},
  {t:'VRM',n:'Vroom Inc.'},{t:'ACMR',n:'ACM Research Inc.'},
  {t:'SMAR',n:'Smartsheet Inc.'},{t:'FRSH',n:'Freshworks Inc.'},
  {t:'ZI',n:'ZoomInfo Technologies Inc.'},{t:'BRZE',n:'Braze Inc.'},
  {t:'TTD',n:'The Trade Desk Inc.'},{t:'MGNI',n:'Magnite Inc.'},
  {t:'IAS',n:'Integral Ad Science Holding Corp.'},{t:'DV',n:'DoubleVerify Holdings Inc.'},
  {t:'PUBM',n:'PubMatic Inc.'},{t:'APP',n:'Applovin Corporation'},
  {t:'IRBT',n:'iRobot Corporation'},{t:'MTTR',n:'Matterport Inc.'},
  {t:'OUST',n:'Ouster Inc.'},{t:'LIDR',n:'AEye Inc.'},
  {t:'LAZR',n:'Luminar Technologies Inc.'},{t:'INVZ',n:'Innoviz Technologies Ltd.'},
];

// De-duplicate the hardcoded stock DB by ticker (fallback only)
const _seenTickers = new Set();
const STOCK_DB_DEDUP = STOCK_DB.filter(s => {
  if (_seenTickers.has(s.t)) return false;
  _seenTickers.add(s.t);
  return true;
});

// Live listing from Alpha Vantage â€” populated on init, searched first in autocomplete
// Format: [{t:'AAPL', n:'Apple Inc.', e:'NYSE'}, ...]
let LIVE_LISTING = [];

// Helper: look up company name from live listing or fallback hardcoded DB
function tickerName(ticker) {
  const live = LIVE_LISTING.find(s => s.t === ticker);
  if (live) return live.n;
  const db = STOCK_DB_DEDUP.find(s => s.t === ticker);
  return db ? db.n : ticker;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE LISTING â€” fetch all US stocks from Alpha Vantage
// Cached in localStorage for 7 days so we don't waste API calls
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LISTING_CACHE_KEY = 'st_listing_cache';
const LISTING_CACHE_TTL = 7 * 24 * 60 * 60 * 1000; // 7 days

async function loadLiveListing() {
  // Try cache first
  try {
    const cached = localStorage.getItem(LISTING_CACHE_KEY);
    if (cached) {
      const { ts, data } = JSON.parse(cached);
      if (Date.now() - ts < LISTING_CACHE_TTL && data.length > 100) {
        LIVE_LISTING = data;
        console.log(`Loaded ${data.length} tickers from cache`);
        return;
      }
    }
  } catch(e) {}

  // Fetch fresh from Alpha Vantage listing status endpoint
  // Must go through a CORS proxy â€” AV's LISTING_STATUS endpoint blocks direct browser requests
  const key = 'd6e7mt9r01qh94m3431gd6e7mt9r01qh94m34320'; // kept for AV listing only
  const CORS_PROXIES = [
    (u) => `https://corsproxy.io/?url=${encodeURIComponent(u)}`,
    (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    (u) => `https://cors-anywhere.herokuapp.com/${u}`,
  ];
  try {
    const avUrl = `https://www.alphavantage.co/query?function=LISTING_STATUS&apikey=${key}`;
    let text = null;

    for (const proxy of CORS_PROXIES) {
      try {
        const res = await fetch(proxy(avUrl), { signal: AbortSignal.timeout(10000) });
        if (!res.ok) continue;
        const t = await res.text();
        // Quick sanity check â€” real CSV starts with "symbol," header
        if (t.trim().startsWith('symbol,') || t.includes('symbol,name,exchange')) {
          text = t;
          break;
        }
      } catch(e) {
        continue; // try next proxy
      }
    }
    if (!text) throw new Error('All proxies failed');

    // Parse CSV: symbol,name,exchange,assetType,ipoDate,delistingDate,status
    const lines = text.trim().split('\n');
    if (lines.length < 2) throw new Error('Bad response');

    const parsed = [];
    for (let i = 1; i < lines.length; i++) {
      // CSV may have quoted fields â€” handle simply
      const cols = lines[i].split(',');
      if (cols.length < 4) continue;
      const symbol  = (cols[0] || '').trim().replace(/^"|"$/g, '');
      const name    = (cols[1] || '').trim().replace(/^"|"$/g, '');
      const exchange= (cols[2] || '').trim().replace(/^"|"$/g, '');
      const type    = (cols[3] || '').trim().replace(/^"|"$/g, '');
      const status  = (cols[6] || '').trim().replace(/^"|"$/g, '');

      // Only active US-listed equities and ETFs
      if (!symbol || !name) continue;
      if (status && status.toLowerCase() !== 'active') continue;
      if (!['NYSE','NASDAQ','NYSE ARCA','NYSE MKT','BATS'].includes(exchange) &&
          !exchange.startsWith('NYSE') && !exchange.startsWith('NASDAQ')) continue;

      parsed.push({ t: symbol, n: name, e: exchange, _type: type });
    }

    if (parsed.length > 100) {
      LIVE_LISTING = parsed;
      try {
        localStorage.setItem(LISTING_CACHE_KEY, JSON.stringify({ ts: Date.now(), data: parsed }));
      } catch(e) {
        // localStorage quota â€” store a trimmed version (symbol+name only)
        const slim = parsed.map(s => ({ t: s.t, n: s.n }));
        try { localStorage.setItem(LISTING_CACHE_KEY, JSON.stringify({ ts: Date.now(), data: slim })); } catch(e2) {}
      }
      console.log(`Fetched ${parsed.length} live tickers for autocomplete`);
    }
  } catch(err) {
    console.warn('Could not fetch live listing, using built-in database', err);
    // Fall through â€” LIVE_LISTING stays empty, autocomplete uses STOCK_DB_DEDUP
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  transactions: [], // {id, ticker, type:'buy'|'sell', shares, price, date, timestamp}
  prices: {},       // {TICKER: {price, prevClose, open, week52H, week52L, mktCap, pe, name}}
  settings: {
    sheetsUrl: 'https://script.google.com/macros/s/AKfycbwxq51qnAJkc6jtRq5IaohJsFnSR62tQSHH-eMBGahMhz2wvaGeX-8NIYjdcoKVZcSo/exec',
    apiKey: 'd6e7mt9r01qh94m3431gd6e7mt9r01qh94m34320',
    lastRefresh: null,
    twitterAccounts: ['QuiverQuant', 'pelositracker']
  }
};

let viewMode = 'total'; // 'total' | 'per'
let changePeriod = '1d';
let sortCol = 'ticker';
let sortDir = 1;
let expandedRows = new Set(); // tickers with expanded lot sub-rows
let currentDetailTicker = null;
let currentEditId = null;
let confirmCallback = null;
let currentTxType = 'buy';
let editTxType = 'buy';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function save() {
  localStorage.setItem('st_transactions', JSON.stringify(state.transactions));
  localStorage.setItem('st_prices', JSON.stringify(state.prices));
  localStorage.setItem('st_settings', JSON.stringify(state.settings));
}

function load() {
  try {
    const tx = localStorage.getItem('st_transactions');
    const pr = localStorage.getItem('st_prices');
    const se = localStorage.getItem('st_settings');
    if (tx) state.transactions = JSON.parse(tx);
    if (pr) state.prices = JSON.parse(pr);
    if (se) {
      const saved = JSON.parse(se);
      // Don't overwrite hard-coded defaults with blank saved values
      if (!saved.apiKey) saved.apiKey = state.settings.apiKey;
      if (!saved.twitterAccounts) saved.twitterAccounts = state.settings.twitterAccounts;
      if (!saved.sheetsUrl) saved.sheetsUrl = state.settings.sheetsUrl;
      state.settings = { ...state.settings, ...saved };
    }
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt$(n, dec=2) {
  if (n == null || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  const str = abs.toLocaleString('en-US', {minimumFractionDigits: dec, maximumFractionDigits: dec});
  return (n < 0 ? '-' : '') + '$' + str;
}
function fmt$K(n) {
  if (n == null || isNaN(n)) return 'â€”';
  const abs = Math.abs(n);
  if (abs >= 1e12) return fmt$(n/1e12, 2) + 'T';
  if (abs >= 1e9) return fmt$(n/1e9, 2) + 'B';
  if (abs >= 1e6) return fmt$(n/1e6, 2) + 'M';
  return fmt$(n, 0);
}
function fmtPct(n) {
  if (n == null || isNaN(n)) return 'â€”';
  return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
}
function fmtNum(n, dec=4) {
  if (n == null || isNaN(n)) return 'â€”';
  return n.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: dec});
}
function fmtDate(dateStr) {
  if (!dateStr) return '';
  let d;

  // Google Sheets serial number (days since Dec 30, 1899)
  if (typeof dateStr === 'number' || /^\d{4,5}$/.test(String(dateStr).trim())) {
    const serial = parseInt(dateStr);
    d = new Date(Date.UTC(1899, 11, 30) + serial * 86400000);

  // ISO format: "2025-01-15"
  } else if (/^\d{4}-\d{2}-\d{2}/.test(String(dateStr).trim())) {
    d = new Date(String(dateStr).trim().substring(0, 10) + 'T00:00:00');

  // US format: "1/15/2025" or "01/15/2025"
  } else if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(String(dateStr).trim())) {
    const parts = String(dateStr).trim().split('/');
    d = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));

  // Fallback: let browser try, but add noon time to avoid timezone day-shift
  } else {
    d = new Date(String(dateStr).trim());
    if (isNaN(d.getTime())) return String(dateStr); // give up, show raw
  }

  if (isNaN(d.getTime())) return String(dateStr);
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
}

// Also normalize a date string coming FROM sheets to YYYY-MM-DD for storage
function normalizeDate(dateStr) {
  if (!dateStr) return '';
  // Already ISO
  if (/^\d{4}-\d{2}-\d{2}/.test(String(dateStr).trim())) return String(dateStr).trim().substring(0, 10);
  // Serial number
  if (typeof dateStr === 'number' || /^\d{4,5}$/.test(String(dateStr).trim())) {
    const d = new Date(Date.UTC(1899, 11, 30) + parseInt(dateStr) * 86400000);
    return d.toISOString().split('T')[0];
  }
  // US format M/D/YYYY
  if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(String(dateStr).trim())) {
    const parts = String(dateStr).trim().split('/');
    const d = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
    return d.toISOString().split('T')[0];
  }
  return String(dateStr);
}
function signClass(n) { return n > 0 ? 'positive' : n < 0 ? 'negative' : 'neutral'; }
function signStr(n, prefix='') {
  if (n == null || isNaN(n)) return '';
  return (n >= 0 ? '+' : '') + prefix;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOLDINGS COMPUTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getHoldings() {
  // Group transactions by ticker
  const map = {};
  for (const tx of state.transactions) {
    if (!map[tx.ticker]) map[tx.ticker] = {buys:[], sells:[]};
    if (tx.type === 'buy') map[tx.ticker].buys.push(tx);
    else map[tx.ticker].sells.push(tx);
  }

  const holdings = [];
  for (const [ticker, {buys, sells}] of Object.entries(map)) {
    const totalBuyShares = buys.reduce((s,t) => s + t.shares, 0);
    const totalSellShares = sells.reduce((s,t) => s + t.shares, 0);
    const currentShares = totalBuyShares - totalSellShares;

    if (currentShares <= 0.0001) continue; // fully sold

    // Weighted average cost
    const totalCost = buys.reduce((s,t) => s + t.shares * t.price, 0);
    const avgCost = totalCost / totalBuyShares;

    // Total invested (cash out for what you still hold, using FIFO-ish: just total buy cost)
    const totalInvested = buys.reduce((s,t) => s + t.shares * t.price, 0);
    // Simpler: total cash spent on buys that represent current position
    // Use weighted avg Ã— current shares for "cost basis of current position"
    const costBasis = avgCost * currentShares;

    const priceData = state.prices[ticker];
    const currentPrice = priceData?.price;
    const currentValue = currentPrice ? currentShares * currentPrice : null;
    const unrealized = currentValue != null ? currentValue - costBasis : null;
    const unrealizedPct = unrealized != null && costBasis > 0 ? (unrealized / costBasis) * 100 : null;

    // Realized gains from sells
    let realizedGain = 0;
    let remainingBuys = buys.map(b => ({...b, remaining: b.shares}));
    for (const sell of sells) {
      let toSell = sell.shares;
      for (const buy of remainingBuys) {
        if (buy.remaining <= 0) continue;
        const matched = Math.min(buy.remaining, toSell);
        realizedGain += matched * (sell.price - buy.price);
        buy.remaining -= matched;
        toSell -= matched;
        if (toSell <= 0) break;
      }
    }

    holdings.push({
      ticker,
      name: priceData?.name || tickerName(ticker),
      shares: currentShares,
      avgCost,
      costBasis,
      currentPrice,
      currentValue,
      unrealized,
      unrealizedPct,
      realizedGain,
      totalInvested,
      priceData
    });
  }
  return holdings;
}

function getPortfolioKPIs() {
  const holdings = getHoldings();
  const totalValue = holdings.reduce((s,h) => s + (h.currentValue || h.costBasis), 0);
  const totalInvested = holdings.reduce((s,h) => s + h.costBasis, 0);
  const unrealized = holdings.reduce((s,h) => s + (h.unrealized || 0), 0);
  
  // All-time realized from ALL transactions including fully sold
  let allRealized = 0;
  const allTickers = [...new Set(state.transactions.map(t=>t.ticker))];
  for (const ticker of allTickers) {
    const buys = state.transactions.filter(t=>t.ticker===ticker && t.type==='buy');
    const sells = state.transactions.filter(t=>t.ticker===ticker && t.type==='sell');
    let rb = buys.map(b=>({...b, remaining: b.shares}));
    for (const sell of sells) {
      let toSell = sell.shares;
      for (const buy of rb) {
        if (buy.remaining <= 0) continue;
        const matched = Math.min(buy.remaining, toSell);
        allRealized += matched * (sell.price - buy.price);
        buy.remaining -= matched;
        toSell -= matched;
        if (toSell <= 0) break;
      }
    }
  }

  return { totalValue, totalInvested, unrealized, allRealized,
    unrealizedPct: totalInvested > 0 ? (unrealized/totalInvested)*100 : 0 };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



// â”€â”€ API quota tracker â”€â”€
// Counts requests used today, resets at midnight UTC. Stored in localStorage.
function getQuotaToday() {
  try {
    const raw = localStorage.getItem('st_quota');
    if (!raw) return { date: '', used: 0, rateLimitHit: false };
    return JSON.parse(raw);
  } catch(e) { return { date: '', used: 0, rateLimitHit: false }; }
}
function recordApiCall(count = 1) {
  const today = new Date().toISOString().split('T')[0];
  const q = getQuotaToday();
  const used = (q.date === today ? q.used : 0) + count;
  const rateLimitHit = q.date === today ? (q.rateLimitHit || false) : false;
  localStorage.setItem('st_quota', JSON.stringify({ date: today, used, rateLimitHit }));
  return used;
}
function getRemainingQuota() {
  // Finnhub free tier: 60 calls/minute â€” no meaningful daily cap for our use.
  // We still track usage for display purposes but don't enforce a limit.
  return 999; // effectively unlimited
}
function setRateLimitHit() {
  const today = new Date().toISOString().split('T')[0];
  const q = getQuotaToday();
  const used = q.date === today ? q.used : 0;
  localStorage.setItem('st_quota', JSON.stringify({ date: today, used: 25, rateLimitHit: true }));
}
function wasRateLimitedToday() {
  const today = new Date().toISOString().split('T')[0];
  const q = getQuotaToday();
  return q.date === today && q.rateLimitHit === true;
}
// Returns minutes until midnight UTC (when quota resets)
function minutesUntilQuotaReset() {
  const now = new Date();
  const midnight = new Date();
  midnight.setUTCHours(24, 0, 0, 0);
  return Math.ceil((midnight - now) / 60000);
}
function formatResetTime() {
  const mins = minutesUntilQuotaReset();
  if (mins < 60) return `${mins}m`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

// â”€â”€ Finnhub price helpers â”€â”€
// Finnhub quote: { c: price, d: change, dp: changePct, h: high, l: low, o: open, pc: prevClose }
function parseFinnhubQuote(data, ticker) {
  if (!data) return null;
  // Finnhub returns c:0 when market is closed but pc (prev close) still has the last price
  const price = data.c && data.c !== 0 ? data.c : data.pc;
  if (!price || price === 0) return null;
  return {
    price,
    prevClose:   data.pc   || price,
    change1d:    data.d    || 0,
    changePct1d: data.dp   || 0,
    open:        data.o    || price,
    high:        data.h    || price,
    low:         data.l    || price,
    volume:      null,
    name:        tickerName(ticker)
  };
}

// Single-ticker fetch â€” used when a new stock is added mid-session
async function fetchPrice(ticker) {
  const key = state.settings.apiKey;
  if (!key) return null;
  try {
    const url = `https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${key}`;
    const r = await fetch(url);
    const data = await r.json();
    // Finnhub returns { error: '...' } or c:0 when rate-limited or invalid
    if (data.error) {
      if (data.error.includes('limit') || data.error.includes('429')) {
        setRateLimitHit();
        renderRefreshBar();
        showToast('API rate limit reached â€” try again in a minute', 'error');
      }
      return null;
    }
    const result = parseFinnhubQuote(data, ticker);
    if (result) recordApiCall(1);
    return result;
  } catch(e) {
    return null;
  }
}

// Fetch all tickers in parallel â€” Finnhub allows 60 calls/min on free tier
async function fetchPricesBatch(tickers) {
  const key = state.settings.apiKey;
  if (!key || !tickers.length) return {};

  const results = {};
  let rateLimitDetected = false;

  const fetches = tickers.map(ticker => {
    const url = `https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${key}`;
    return fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          console.warn(`Finnhub error for ${ticker}:`, data.error);
          if (data.error.includes('limit') || data.error.includes('429')) rateLimitDetected = true;
          return;
        }
        console.log(`Finnhub ${ticker}:`, data);
        const parsed = parseFinnhubQuote(data, ticker);
        if (parsed) results[ticker] = parsed;
        else console.warn(`parseFinnhubQuote returned null for ${ticker}`, data);
      })
      .catch(e => console.error(`Finnhub fetch failed for ${ticker}:`, e));
  });

  await Promise.allSettled(fetches);

  if (rateLimitDetected) {
    setRateLimitHit();
  } else {
    recordApiCall(tickers.length);
  }

  return results;
}

// Fetch company profile from Finnhub for 52W high/low, market cap, P/E
async function fetchCompanyProfile(ticker) {
  const key = state.settings.apiKey;
  if (!key) return;
  try {
    const [metricRes, quoteRes] = await Promise.all([
      fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${ticker}&metric=all&token=${key}`).then(r=>r.json()),
      fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${key}`).then(r=>r.json())
    ]);
    if (!state.prices[ticker]) return;
    const m = metricRes.metric || {};
    if (m['52WeekHigh'])  state.prices[ticker].week52H = m['52WeekHigh'];
    if (m['52WeekLow'])   state.prices[ticker].week52L = m['52WeekLow'];
    if (m['marketCapitalization']) state.prices[ticker].mktCap = m['marketCapitalization'] * 1e6;
    if (m['peBasicExclExtraTTM'])  state.prices[ticker].pe = m['peBasicExclExtraTTM'];
    save();
    // Re-render info card
    const infoCard = document.getElementById('detail-info-card');
    const p = state.prices[ticker];
    const holdings = getHoldings();
    const h = holdings.find(x => x.ticker === ticker);
    if (infoCard && p) {
      const infoRows = [];
      if (p.open)      infoRows.push(['Open',       fmt$(p.open)]);
      if (p.high)      infoRows.push(['Day High',   fmt$(p.high)]);
      if (p.low)       infoRows.push(['Day Low',    fmt$(p.low)]);
      if (p.prevClose) infoRows.push(['Prev Close', fmt$(p.prevClose)]);
      if (p.week52H)   infoRows.push(['52W High',   fmt$(p.week52H)]);
      if (p.week52L)   infoRows.push(['52W Low',    fmt$(p.week52L)]);
      if (p.mktCap)    infoRows.push(['Market Cap', fmt$K(p.mktCap)]);
      if (p.pe)        infoRows.push(['P/E Ratio',  fmtNum(p.pe, 2)]);
      if (h) {
        infoRows.push(['Shares Held', fmtNum(h.shares, 6)]);
        infoRows.push(['Cost Basis',  fmt$(h.costBasis)]);
        infoRows.push(['Realized P&L', (h.realizedGain>=0?'+':'')+fmt$(h.realizedGain)]);
      }
      infoCard.innerHTML = infoRows.map(([label, val]) =>
        `<div class="detail-info-row"><span class="detail-info-label">${label}</span><span class="detail-info-val">${val}</span></div>`
      ).join('');
    }
  } catch(e) {}
}

async function refreshAllPrices() {
  const tickers = [...new Set(state.transactions.map(t => t.ticker))];
  if (!tickers.length) { showToast('No stocks to refresh', 'error'); return; }
  if (!state.settings.apiKey) { showToast('Add API key in Settings first', 'error'); return; }

  // Check if per-minute rate limit was recently hit
  if (wasRateLimitedToday()) {
    // Reset the flag so user can try again (Finnhub limit is per-minute, not per-day)
    const today = new Date().toISOString().split('T')[0];
    const q = getQuotaToday();
    localStorage.setItem('st_quota', JSON.stringify({ date: today, used: q.used || 0, rateLimitHit: false }));
  }

  // Animate refresh button
  const refreshBtn = document.getElementById('refresh-btn');
  const refreshIcon = document.getElementById('refresh-icon');
  if (refreshBtn) { refreshBtn.disabled = true; refreshBtn.style.opacity = '0.6'; }
  if (refreshIcon) refreshIcon.style.animation = 'spin 1s linear infinite';

  showToast('Refreshing pricesâ€¦', '');

  // Fire all tickers in parallel using Finnhub quote endpoint
  let updated = 0;
  const results = await fetchPricesBatch(tickers);
  for (const [ticker, data] of Object.entries(results)) {
    state.prices[ticker] = { ...state.prices[ticker], ...data };
    updated++;
  }

  state.settings.lastRefresh = new Date().toISOString();
  save();
  renderHome();
  renderSettings();
  // Stop button animation
  if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.style.opacity = '1'; }
  if (refreshIcon) refreshIcon.style.animation = '';

  renderRefreshBar();
  const left = getRemainingQuota();
  if (wasRateLimitedToday()) {
    showToast('Rate limit hit â€” wait a minute then try again', 'error');
  } else if (updated === 0) {
    // Could be market closed (c:0), invalid key, or network issue
    showToast('No prices returned â€” market may be closed or check API key in Settings', 'error');
  } else {
    showToast(`Updated ${updated}/${tickers.length} prices`, 'success');
  }
}

// Change % by period â€” uses live 1d data or cached period snapshots
function getPriceChange(ticker, period) {
  const p = state.prices[ticker];
  if (!p || !p.price) return null;
  if (period === '1d') {
    if (p.change1d == null) return null;
    return { amt: p.change1d, pct: p.changePct1d };
  }
  // For other periods, use stored period open prices (populated by fetchPeriodChange)
  const snap = p.periodSnaps && p.periodSnaps[period];
  if (!snap) return null;
  const amt = p.price - snap;
  const pct = snap > 0 ? (amt / snap) * 100 : 0;
  return { amt, pct };
}

// Fetch the opening price for a given period so we can show period change.
// Called lazily when changePeriod changes.
async function fetchPeriodChange(ticker, period) {
  const key = state.settings.apiKey;
  const p = state.prices[ticker];
  if (!key || !p || period === '1d') return;
  // Already have it cached
  if (p.periodSnaps && p.periodSnaps[period]) return;

  const now = Math.floor(Date.now() / 1000);
  // Go back slightly further than needed so we always get at least one candle
  const offsets = { '1w': 9, '1m': 35, '1y': 370 };
  const days = offsets[period] || 9;
  const from = now - days * 86400;

  try {
    const url = `https://finnhub.io/api/v1/stock/candle?symbol=${ticker}&resolution=D&from=${from}&to=${now}&token=${key}`;
    const r = await fetch(url);
    const data = await r.json();
    if (data.s !== 'ok' || !data.c || !data.c.length) return;
    // Use the close of the FIRST candle in the range as the "price N days ago"
    // This is more accurate than using open price
    const basePrice = data.c[0];
    if (!basePrice || basePrice === 0) return;
    if (!state.prices[ticker].periodSnaps) state.prices[ticker].periodSnaps = {};
    state.prices[ticker].periodSnaps[period] = basePrice;
    save();
  } catch(e) { console.error('fetchPeriodChange error:', ticker, period, e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Populate the stock-select dropdown with current holdings
function populateStockSelect(activeTicker) {
  const sel = document.getElementById('stock-select');
  if (!sel) return;
  const holdings = getHoldings().sort((a,b) => a.ticker.localeCompare(b.ticker));
  if (!holdings.length) {
    sel.innerHTML = '<option value="">No holdings yet</option>';
    return;
  }
  sel.innerHTML = holdings.map(h =>
    `<option value="${h.ticker}" ${h.ticker === activeTicker ? 'selected' : ''}>${h.ticker} â€” ${h.name || tickerName(h.ticker)}</option>`
  ).join('');
}

function navigate(screen, ticker) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`screen-${screen}`).classList.add('active');

  const addBtn = document.getElementById('add-btn');

  if (screen === 'home') {
    document.getElementById('tab-home').classList.add('active');
    document.getElementById('header-title').textContent = 'Portfolio';
    document.getElementById('header-subtitle').style.display = 'none';
    addBtn.style.display = 'flex';
    renderHome();

  } else if (screen === 'detail') {
    // If no ticker given, default to first holding alphabetically
    if (!ticker) {
      const holdings = getHoldings().sort((a,b) => a.ticker.localeCompare(b.ticker));
      ticker = holdings.length ? holdings[0].ticker : null;
    }
    if (!ticker) {
      // No holdings at all â€” show portfolio instead
      navigate('home'); return;
    }
    currentDetailTicker = ticker;
    document.getElementById('tab-detail').classList.add('active');
    document.getElementById('tab-detail-label').textContent = 'Stock';
    document.getElementById('header-title').textContent = ticker;
    const p = state.prices[ticker];
    document.getElementById('header-subtitle').textContent = p?.name || tickerName(ticker);
    document.getElementById('header-subtitle').style.display = 'block';
    addBtn.style.display = 'none';
    populateStockSelect(ticker);
    renderDetail(ticker);

  } else if (screen === 'history') {
    document.getElementById('tab-history').classList.add('active');
    document.getElementById('header-title').textContent = 'History';
    document.getElementById('header-subtitle').style.display = 'none';
    addBtn.style.display = 'flex';
    renderHistory();

  } else if (screen === 'news') {
    document.getElementById('tab-news').classList.add('active');
    document.getElementById('header-title').textContent = 'News';
    document.getElementById('header-subtitle').style.display = 'none';
    addBtn.style.display = 'none';
    renderNews();

  } else if (screen === 'settings') {
    document.getElementById('tab-settings').classList.add('active');
    document.getElementById('header-title').textContent = 'Settings';
    document.getElementById('header-subtitle').style.display = 'none';
    addBtn.style.display = 'none';
    renderSettings();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setViewMode(mode, btn) {
  viewMode = mode;
  document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderHoldingsTable();
}

function setChangePeriod(p, btn) {
  changePeriod = p;
  document.querySelectorAll('.change-period-mini').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  if (p === '1d') {
    // 1d data is always available â€” render immediately
    renderHoldingsTable();
  } else {
    // Check which tickers still need period data fetched
    const tickers = [...new Set(state.transactions.map(t => t.ticker))];
    const needsFetch = tickers.filter(t => {
      const pr = state.prices[t];
      return pr && !(pr.periodSnaps && pr.periodSnaps[p]);
    });

    if (needsFetch.length === 0) {
      // All data already cached â€” render immediately
      renderHoldingsTable();
    } else {
      // Render now (will show â€” for missing ones), then re-render when fetches done
      renderHoldingsTable();
      Promise.all(needsFetch.map(t => fetchPeriodChange(t, p)))
        .then(() => renderHoldingsTable());
    }
  }
}

function renderHome() {
  renderHomeKPIs();
  renderHoldingsTable();
  // Show amber notice if we have holdings but no prices loaded for any of them
  const notice = document.getElementById('no-prices-notice');
  if (notice) {
    const holdings = getHoldings();
    const anyMissingPrice = holdings.length > 0 && holdings.some(h => h.currentPrice == null);
    notice.style.display = anyMissingPrice ? 'flex' : 'none';
  }
}

function renderHomeKPIs() {
  const kpis = getPortfolioKPIs();
  
  const tvEl = document.getElementById('kpi-total-value');
  tvEl.textContent = fmt$(kpis.totalValue);
  tvEl.className = 'kpi-value';

  const tcEl = document.getElementById('kpi-total-change');
  const unrealAmt = kpis.unrealized;
  const unrealPct = kpis.unrealizedPct;
  tcEl.textContent = unrealAmt !== 0 ? `${signStr(unrealAmt)}${fmt$(unrealAmt)} (${fmtPct(unrealPct)}) unrealized` : '';
  tcEl.className = 'kpi-change ' + signClass(unrealAmt);

  document.getElementById('kpi-invested').textContent = fmt$(kpis.totalInvested);

  const urEl = document.getElementById('kpi-unrealized');
  urEl.textContent = fmt$(kpis.unrealized);
  urEl.className = 'kpi-value ' + signClass(kpis.unrealized);

  const urPEl = document.getElementById('kpi-unrealized-pct');
  urPEl.textContent = fmtPct(kpis.unrealizedPct);
  urPEl.className = 'kpi-change ' + signClass(kpis.unrealized);

  const rzEl = document.getElementById('kpi-realized');
  rzEl.textContent = fmt$(kpis.allRealized);
  rzEl.className = 'kpi-value ' + signClass(kpis.allRealized);

  renderRefreshBar();
}

function renderRefreshBar() {
  const refreshEl  = document.getElementById('home-last-refresh');
  const btn        = document.getElementById('refresh-btn');
  const rateBanner = document.getElementById('rate-limit-banner');
  if (!refreshEl) return;

  const rateLimited = wasRateLimitedToday();

  // â”€â”€ Rate-limit banner â”€â”€
  if (rateBanner) {
    rateBanner.style.display = rateLimited ? 'flex' : 'none';
  }

  // â”€â”€ Re-enable button (rate limit is per-minute, not per-day) â”€â”€
  if (btn) {
    btn.disabled      = false;
    btn.style.opacity = '1';
    btn.style.cursor  = 'pointer';
  }

  // â”€â”€ Last refresh timestamp â”€â”€
  if (!state.settings.lastRefresh) {
    refreshEl.textContent = state.settings.apiKey
      ? 'Refreshing pricesâ€¦'
      : 'Add API key in Settings';
    return;
  }

  const d = new Date(state.settings.lastRefresh);
  const now = new Date();
  const diffMin = Math.floor((now - d) / 60000);
  let timeStr;
  if (diffMin < 1)         timeStr = 'just now';
  else if (diffMin < 60)   timeStr = `${diffMin} minute${diffMin===1?'':'s'} ago`;
  else if (diffMin < 1440) {
    const h = Math.floor(diffMin / 60);
    const m = diffMin % 60;
    timeStr = `${h}h ${m}m ago`;
  } else {
    timeStr = d.toLocaleDateString('en-US', {month:'short', day:'numeric'})
            + ' at ' + d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});
  }
  refreshEl.textContent = timeStr;
}

function renderHoldingsTable() {
  const holdings = getHoldings();
  const thead = document.getElementById('table-head-row');
  const tbody = document.getElementById('holdings-body');
  const periodLabel = changePeriod === '1d' ? '24h' : changePeriod.toUpperCase();

  if (!holdings.length) {
    thead.innerHTML = '';
    tbody.innerHTML = `<tr><td colspan="6" style="padding:0">
      <div class="empty-state">
        <div class="icon">ðŸ“Š</div>
        <h3>No holdings yet</h3>
        <p>Tap + to add your first stock purchase</p>
      </div>
    </td></tr>`;
    return;
  }

  const isTotal = viewMode === 'total';

  // â”€â”€ Column definitions â”€â”€
  const cols = isTotal ? [
    {key:'ticker',       label:'Ticker',              sortable:true},
    {key:'currentValue', label:'Value',               sortable:true, right:true},
    {key:'costBasis',    label:'Invested',            sortable:true, right:true},
    {key:'unrealized',   label:'Total Change',        sortable:true, right:true},
    {key:'periodChange', label:`${periodLabel} Change`, sortable:true, right:true},
  ] : [
    {key:'ticker',       label:'Ticker',              sortable:true},
    {key:'currentPrice', label:'Price',               sortable:true, right:true},
    {key:'avgCost',      label:'Avg Cost',            sortable:true, right:true},
    {key:'unrealized',   label:'Total Change',        sortable:true, right:true},
    {key:'periodChange', label:`${periodLabel} Change`, sortable:true, right:true},
  ];

  // â”€â”€ Attach period change to each holding â”€â”€
  const holdingsWithChange = holdings.map(h => {
    const ch = getPriceChange(h.ticker, changePeriod);
    return { ...h, periodChange: ch ? ch.pct : null, periodChangeAmt: ch ? ch.amt : null };
  });

  // â”€â”€ Header â”€â”€
  thead.innerHTML = cols.map(c => `
    <th class="${c.right?'right':''} ${sortCol===c.key?'sorted':''}"
        ${c.sortable ? `onclick="sortTable('${c.key}')"` : ''}>
      ${c.label}${c.sortable && sortCol===c.key ? `<span class="sort-arrow">${sortDir===1?'â†“':'â†‘'}</span>` : ''}
    </th>`).join('');

  // â”€â”€ Sort â”€â”€
  let sorted = [...holdingsWithChange];
  sorted.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (sortCol === 'ticker') return sortDir * (va||'').localeCompare(vb||'');
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    return sortDir * (vb - va);
  });

  // â”€â”€ Build rows â”€â”€
  const rows = [];
  for (const h of sorted) {
    const periodPill = h.periodChange != null
      ? `<span class="change-pill ${signClass(h.periodChangeAmt)}">${h.periodChangeAmt >= 0 ? '+' : ''}${h.periodChange.toFixed(2)}%</span>`
      : `<span class="change-pill neutral">â€”</span>`;

    // Get buy lots for this ticker (for dropdown)
    const lots = state.transactions
      .filter(t => t.ticker === h.ticker && t.type === 'buy')
      .sort((a,b) => new Date(a.date) - new Date(b.date));
    const isExpanded = expandedRows.has(h.ticker);
    const hasMultiple = lots.length > 1;
    const chevron = hasMultiple
      ? `<span class="lot-chevron${isExpanded?' open':''}" onclick="toggleExpand('${h.ticker}',event)">â–¶</span>`
      : `<span style="display:inline-block;width:14px;margin-right:6px"></span>`;

    if (isTotal) {
      const plSign = h.unrealized != null ? signClass(h.unrealized) : '';
      const plStr  = h.unrealized != null
        ? `<span class="${plSign}" style="font-weight:600">${h.unrealized>=0?'+':''}${fmt$(h.unrealized)}<br><span style="font-size:10px;font-weight:400">${h.unrealizedPct!=null?fmtPct(h.unrealizedPct):''}</span></span>`
        : 'â€”';

      rows.push(`<tr class="expandable-row" onclick="navigate('detail','${h.ticker}')">
        <td>
          <div class="ticker-cell">
            <div style="display:flex;align-items:center">${chevron}<span class="ticker-name">${h.ticker}</span></div>
            <span class="ticker-shares" style="padding-left:20px">${fmtNum(h.shares,4)} shares</span>
          </div>
        </td>
        <td class="right price-cell">${h.currentValue != null ? fmt$(h.currentValue) : '<span style="color:var(--text3);font-size:12px">No price</span>'}</td>
        <td class="right price-cell">${fmt$(h.costBasis)}</td>
        <td class="right price-cell">${plStr}</td>
        <td class="right">${periodPill}</td>
      </tr>`);
    } else {
      // /share view: shares under ticker, then Price | Avg Cost | Total Change | Period Change
      const plPct   = h.unrealizedPct;
      const plSign  = plPct != null ? signClass(plPct) : '';
      const plStr   = plPct != null
        ? `<span class="${plSign}" style="font-weight:600">${fmtPct(plPct)}<br><span style="font-size:10px;font-weight:400">${h.unrealized!=null?(h.unrealized>=0?'+':'')+fmt$(h.unrealized):''}</span></span>`
        : 'â€”';

      rows.push(`<tr class="expandable-row" onclick="navigate('detail','${h.ticker}')">
        <td>
          <div class="ticker-cell">
            <div style="display:flex;align-items:center">${chevron}<span class="ticker-name">${h.ticker}</span></div>
            <span class="ticker-shares" style="padding-left:20px">${fmtNum(h.shares,4)} shares</span>
          </div>
        </td>
        <td class="right price-cell">${h.currentPrice != null ? fmt$(h.currentPrice) : '<span style="color:var(--text3);font-size:12px">No price</span>'}</td>
        <td class="right price-cell">${fmt$(h.avgCost)}</td>
        <td class="right price-cell">${plStr}</td>
        <td class="right">${periodPill}</td>
      </tr>`);
    }

    // â”€â”€ Sub-rows (lot breakdown) â”€â”€
    if (isExpanded && hasMultiple) {
      for (const lot of lots) {
        const lotCurrent = h.currentPrice;
        const lotVal     = lotCurrent ? lot.shares * lotCurrent : null;
        const lotCost    = lot.shares * lot.price;
        const lotPL      = lotVal != null ? lotVal - lotCost : null;
        const lotPLPct   = lotPL != null && lotCost > 0 ? (lotPL/lotCost)*100 : null;
        const lotSign    = lotPL != null ? signClass(lotPL) : '';

        if (isTotal) {
          const lotPlStr = lotPL != null
            ? `<span class="${lotSign}" style="font-weight:600">${lotPL>=0?'+':''}${fmt$(lotPL)}<br><span style="font-size:10px;font-weight:400">${lotPLPct!=null?fmtPct(lotPLPct):''}</span></span>`
            : 'â€”';
          rows.push(`<tr class="sub-row" onclick="event.stopPropagation()">
            <td>
              <div class="ticker-cell">
                <span class="ticker-name" style="font-size:12px">${fmtDate(lot.date)}</span>
                <span class="ticker-shares">${fmtNum(lot.shares,4)} shares @ ${fmt$(lot.price)}</span>
              </div>
            </td>
            <td class="right price-cell">${lotVal != null ? fmt$(lotVal) : 'â€”'}</td>
            <td class="right price-cell">${fmt$(lotCost)}</td>
            <td class="right price-cell">${lotPlStr}</td>
            <td class="right"><span class="change-pill neutral">lot</span></td>
          </tr>`);
        } else {
          const lotPlPctStr = lotPLPct != null
            ? `<span class="${lotSign}" style="font-weight:600">${fmtPct(lotPLPct)}<br><span style="font-size:10px;font-weight:400">${lotPL!=null?(lotPL>=0?'+':'')+fmt$(lotPL):''}</span></span>`
            : 'â€”';
          rows.push(`<tr class="sub-row" onclick="event.stopPropagation()">
            <td>
              <div class="ticker-cell">
                <span class="ticker-name" style="font-size:12px">${fmtDate(lot.date)}</span>
                <span class="ticker-shares">${fmtNum(lot.shares,4)} shares</span>
              </div>
            </td>
            <td class="right price-cell">${lotCurrent != null ? fmt$(lotCurrent) : 'â€”'}</td>
            <td class="right price-cell">${fmt$(lot.price)}</td>
            <td class="right price-cell">${lotPlPctStr}</td>
            <td class="right"><span class="change-pill neutral">lot</span></td>
          </tr>`);
        }
      }
    }
  }

  tbody.innerHTML = rows.join('');
}

function toggleExpand(ticker, event) {
  event.stopPropagation();
  if (expandedRows.has(ticker)) expandedRows.delete(ticker);
  else expandedRows.add(ticker);
  renderHoldingsTable();
}

function sortTable(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = 1; }
  renderHoldingsTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDetail(ticker) {
  const holdings = getHoldings();
  const h = holdings.find(x => x.ticker === ticker);
  const p = state.prices[ticker];

  // â”€â”€ Header â”€â”€
  const header = document.getElementById('detail-header');
  const price = p?.price;
  const changeAmt = p?.change1d;
  const changePct = p?.changePct1d;
  const avgCost = h?.avgCost;
  const priceDiff = (price && avgCost) ? price - avgCost : null;
  const priceDiffPct = (priceDiff != null && avgCost > 0) ? (priceDiff / avgCost) * 100 : null;

  header.innerHTML = `
    <div class="stock-detail-info">
      <div class="stock-detail-ticker">${ticker}</div>
      <div class="stock-detail-company">${p?.name || tickerName(ticker)}</div>
    </div>
    <div class="stock-detail-price">
      <div class="stock-detail-price-val">${price ? fmt$(price) : 'â€”'}</div>
      ${changeAmt != null ? `<div class="stock-detail-price-change ${signClass(changeAmt)}">${changeAmt>=0?'+':''}${fmt$(changeAmt)} (${fmtPct(changePct)}) today</div>` : ''}
    </div>
  `;

  // â”€â”€ Price vs cost bar â”€â”€
  let priceBarEl = document.getElementById('detail-price-bar');
  if (!priceBarEl) {
    priceBarEl = document.createElement('div');
    priceBarEl.id = 'detail-price-bar';
    priceBarEl.style.cssText = 'margin:0 16px 16px;display:flex;gap:10px';
    const kpiEl = document.getElementById('detail-kpis');
    kpiEl.parentNode.insertBefore(priceBarEl, kpiEl);
  }
  if (h && price) {
    priceBarEl.innerHTML = `
      <div style="flex:1;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow)">
        <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);margin-bottom:4px">Current Price</div>
        <div style="font-size:22px;font-weight:700;font-family:var(--mono);color:var(--text)">${fmt$(price)}</div>
        ${changeAmt != null ? `<div style="font-size:12px;font-weight:500;margin-top:2px" class="${signClass(changeAmt)}">${changeAmt>=0?'+':''}${fmt$(changeAmt)} today</div>` : ''}
      </div>
      <div style="flex:1;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow)">
        <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);margin-bottom:4px">Your Avg Cost</div>
        <div style="font-size:22px;font-weight:700;font-family:var(--mono);color:var(--text)">${fmt$(avgCost)}</div>
        ${priceDiff != null ? `<div style="font-size:12px;font-weight:500;margin-top:2px" class="${signClass(priceDiff)}">${priceDiff>=0?'+':''}${fmt$(priceDiff)} (${fmtPct(priceDiffPct)})</div>` : ''}
      </div>
    `;
  } else {
    priceBarEl.innerHTML = '';
  }

  // â”€â”€ KPI grid â”€â”€
  const kpiEl = document.getElementById('detail-kpis');
  if (h) {
    kpiEl.innerHTML = `
      <div class="kpi-card"><div class="kpi-label">Current Value</div><div class="kpi-value">${h.currentValue != null ? fmt$(h.currentValue) : 'â€”'}</div></div>
      <div class="kpi-card"><div class="kpi-label">Invested</div><div class="kpi-value">${fmt$(h.costBasis)}</div></div>
      <div class="kpi-card">
        <div class="kpi-label">Unrealized P&L</div>
        <div class="kpi-value ${signClass(h.unrealized)}">${h.unrealized != null ? (h.unrealized>=0?'+':'')+fmt$(h.unrealized) : 'â€”'}</div>
        <div class="kpi-change ${signClass(h.unrealized)}">${h.unrealizedPct != null ? fmtPct(h.unrealizedPct) : ''}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Realized P&L</div>
        <div class="kpi-value ${signClass(h.realizedGain)}">${(h.realizedGain>=0?'+':'')+fmt$(h.realizedGain)}</div>
      </div>
    `;
  } else {
    kpiEl.innerHTML = '<div class="kpi-card full"><div class="kpi-label">Not in current holdings</div></div>';
  }

  // â”€â”€ Price change table (async, fills in period data as it arrives) â”€â”€
  renderDetailPriceTable(ticker);

  // â”€â”€ Analyst ratings â”€â”€
  renderDetailAnalyst(ticker);

  // â”€â”€ Stock info card â”€â”€
  const infoCard = document.getElementById('detail-info-card');
  const infoRows = [];
  if (p?.open)      infoRows.push(['Open',       fmt$(p.open)]);
  if (p?.high)      infoRows.push(['Day High',   fmt$(p.high)]);
  if (p?.low)       infoRows.push(['Day Low',    fmt$(p.low)]);
  if (p?.prevClose) infoRows.push(['Prev Close', fmt$(p.prevClose)]);
  if (p?.week52H)   infoRows.push(['52W High',   fmt$(p.week52H)]);
  if (p?.week52L)   infoRows.push(['52W Low',    fmt$(p.week52L)]);
  if (p?.mktCap)    infoRows.push(['Market Cap', fmt$K(p.mktCap)]);
  if (p?.pe)        infoRows.push(['P/E Ratio',  fmtNum(p.pe, 2)]);
  if (h) {
    infoRows.push(['Shares Held', fmtNum(h.shares, 6)]);
    infoRows.push(['Cost Basis',  fmt$(h.costBasis)]);
    infoRows.push(['Realized P&L', (h.realizedGain>=0?'+':'')+fmt$(h.realizedGain)]);
  }
  infoCard.innerHTML = infoRows.length
    ? infoRows.map(([label, val]) =>
        `<div class="detail-info-row"><span class="detail-info-label">${label}</span><span class="detail-info-val">${val}</span></div>`
      ).join('')
    : '<div class="detail-info-row"><span class="detail-info-label" style="color:var(--text3)">No additional data available</span></div>';

  if (state.settings.apiKey && p && (!p.week52H || !p.mktCap)) fetchCompanyProfile(ticker);

  // â”€â”€ LT/ST breakdown â”€â”€
  renderLtStBreakdown(ticker, h);

  // â”€â”€ Transactions â”€â”€
  renderDetailTransactions(ticker);
}

// â”€â”€ Price Change Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDetailPriceTable(ticker) {
  const el = document.getElementById('detail-price-table');
  if (!el) return;
  const p = state.prices[ticker];
  const key = state.settings.apiKey;

  if (!p?.price) {
    el.innerHTML = `<table class="price-table"><tbody>
      <tr><td colspan="4" style="text-align:center;padding:14px;color:var(--text3);font-size:13px;font-family:var(--font)">
        Refresh prices to see performance data
      </td></tr></tbody></table>`;
    return;
  }

  // Show skeleton immediately
  el.innerHTML = `<table class="price-table">
    <thead><tr><th>Period</th><th>Start Price</th><th>Change $</th><th>Change %</th></tr></thead>
    <tbody><tr><td colspan="4" style="text-align:center;padding:14px;color:var(--text3);font-size:12px;font-family:var(--font)">Loadingâ€¦</td></tr></tbody>
  </table>`;

  const periods = [
    { label: 'Today',   id: '1d',  days: null },
    { label: '1 Week',  id: '1w',  days: 9    },
    { label: '1 Month', id: '1m',  days: 35   },
    { label: '3 Month', id: '3m',  days: 100  },
    { label: '6 Month', id: '6m',  days: 200  },
    { label: '1 Year',  id: '1y',  days: 375  },
  ];

  // Fetch missing snaps in parallel
  if (key) {
    await Promise.all(
      periods
        .filter(pd => pd.days !== null && !(p.periodSnaps?.[pd.id]))
        .map(pd => fetchPeriodChange(ticker, pd.id))
    );
  }

  const rows = periods.map(pd => {
    const chg = getPriceChange(ticker, pd.id);
    if (!chg) {
      return `<tr>
        <td>${pd.label}</td>
        <td class="tbl-na">â€”</td><td class="tbl-na">â€”</td><td class="tbl-na">â€”</td>
      </tr>`;
    }
    const start = p.price - chg.amt;
    const cls = signClass(chg.amt);
    const sign = chg.amt >= 0 ? '+' : '';
    return `<tr>
      <td>${pd.label}</td>
      <td>${fmt$(start)}</td>
      <td class="${cls}">${sign}${fmt$(chg.amt)}</td>
      <td class="${cls}">${sign}${fmtPct(chg.pct)}</td>
    </tr>`;
  }).join('');

  el.innerHTML = `<table class="price-table">
    <thead><tr><th>Period</th><th>Start Price</th><th>Change $</th><th>Change %</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

// â”€â”€ Analyst Ratings (detail page) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDetailAnalyst(ticker) {
  const el = document.getElementById('detail-analyst');
  if (!el) return;
  const key = state.settings.apiKey;
  if (!key) { el.innerHTML = '<div style="color:var(--text3);font-size:13px">Add API key in Settings to see ratings</div>'; return; }
  el.innerHTML = '<div style="color:var(--text3);font-size:13px">Loadingâ€¦</div>';
  try {
    const r = await fetch(`https://finnhub.io/api/v1/stock/recommendation?symbol=${ticker}&token=${key}`);
    const data = await r.json();
    if (!Array.isArray(data) || !data.length) {
      el.innerHTML = '<div style="color:var(--text3);font-size:13px">No analyst data available</div>';
      return;
    }
    el.innerHTML = buildAnalystHTML(data[0]);
  } catch(e) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px">Failed to load analyst data</div>';
  }
}

function buildAnalystHTML(rec) {
  const total = (rec.strongBuy||0)+(rec.buy||0)+(rec.hold||0)+(rec.sell||0)+(rec.strongSell||0);
  if (!total) return '<div style="color:var(--text3);font-size:13px">No analyst data</div>';
  const bullish = (rec.strongBuy||0)+(rec.buy||0);
  const bearish  = (rec.sell||0)+(rec.strongSell||0);
  let consensus = 'Hold', cColor = '#f59e0b';
  if (bullish/total >= 0.5) { consensus = 'Buy'; cColor = '#1a9e5c'; }
  else if (bearish/total >= 0.5) { consensus = 'Sell'; cColor = '#d63b3b'; }
  const bars = [
    { label:'Strong Buy',  val:rec.strongBuy||0,  color:'#1a9e5c' },
    { label:'Buy',         val:rec.buy||0,         color:'#4caf50' },
    { label:'Hold',        val:rec.hold||0,        color:'#f59e0b' },
    { label:'Sell',        val:rec.sell||0,        color:'#f97316' },
    { label:'Strong Sell', val:rec.strongSell||0,  color:'#d63b3b' },
  ];
  return `<div class="analyst-wrap">
    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px">
      <span style="font-size:12px;color:var(--text2)">${total} analysts${rec.period ? ' Â· '+rec.period : ''}</span>
      <span style="font-size:14px;font-weight:700;color:${cColor}">${consensus}</span>
    </div>
    ${bars.map(b=>`<div class="analyst-row">
      <div class="analyst-lbl">${b.label}</div>
      <div class="analyst-track"><div class="analyst-fill" style="width:${(b.val/total*100).toFixed(1)}%;background:${b.color}"></div></div>
      <div class="analyst-cnt">${b.val}</div>
    </div>`).join('')}
  </div>`;
}

function renderLtStBreakdown(ticker, holding) {
  // Remove existing breakdown section if present
  const existing = document.getElementById('lt-st-section');
  if (existing) existing.remove();

  if (!holding) return;

  const now = new Date();
  const oneYearAgo = new Date(now);
  oneYearAgo.setFullYear(now.getFullYear() - 1);

  // Use FIFO to determine which shares are LT vs ST
  // Walk buys oldest-first, apply sells oldest-first, remainder = current position
  const buys = state.transactions
    .filter(t => t.ticker === ticker && t.type === 'buy')
    .sort((a,b) => new Date(a.date) - new Date(b.date));
  const sells = state.transactions
    .filter(t => t.ticker === ticker && t.type === 'sell')
    .sort((a,b) => new Date(a.date) - new Date(b.date));

  // Apply sells FIFO
  let lots = buys.map(b => ({ ...b, remaining: b.shares }));
  for (const sell of sells) {
    let toSell = sell.shares;
    for (const lot of lots) {
      if (lot.remaining <= 0) continue;
      const matched = Math.min(lot.remaining, toSell);
      lot.remaining -= matched;
      toSell -= matched;
      if (toSell <= 0) break;
    }
  }

  // Remaining lots â€” split into LT and ST
  let ltShares = 0, stShares = 0;
  let ltCost = 0, stCost = 0;
  for (const lot of lots) {
    if (lot.remaining <= 0) continue;
    const purchaseDate = new Date(lot.date + 'T00:00:00');
    if (purchaseDate <= oneYearAgo) {
      ltShares += lot.remaining;
      ltCost += lot.remaining * lot.price;
    } else {
      stShares += lot.remaining;
      stCost += lot.remaining * lot.price;
    }
  }

  const price = holding.currentPrice;
  const ltValue = price ? ltShares * price : null;
  const stValue = price ? stShares * price : null;
  const ltUnrealized = ltValue != null ? ltValue - ltCost : null;
  const stUnrealized = stValue != null ? stValue - stCost : null;
  const totalShares = ltShares + stShares;
  const ltPct = totalShares > 0 ? (ltShares / totalShares) * 100 : 0;
  const stPct = totalShares > 0 ? (stShares / totalShares) * 100 : 0;

  // â”€â”€ Tax estimates (Colorado, ~$65-70k income) â”€â”€
  // Federal LT rate: 15% | Federal ST rate: 22% | Colorado flat: 4.40%
  const TAX_LT = 0.1940; // 15% federal + 4.40% CO
  const TAX_ST = 0.2640; // 22% federal + 4.40% CO

  // Only calculate tax on gains (not on losses â€” can't owe tax on a loss)
  const ltGainTaxable  = ltUnrealized  != null ? Math.max(0, ltUnrealized)  : null;
  const stGainTaxable  = stUnrealized  != null ? Math.max(0, stUnrealized)  : null;
  const ltTaxOwed      = ltGainTaxable  != null ? ltGainTaxable  * TAX_LT : null;
  const stTaxOwed      = stGainTaxable  != null ? stGainTaxable  * TAX_ST : null;
  const ltAfterTax     = ltUnrealized   != null && ltTaxOwed != null ? ltUnrealized  - ltTaxOwed  : null;
  const stAfterTax     = stUnrealized   != null && stTaxOwed != null ? stUnrealized  - stTaxOwed  : null;

  function taxRow(label, gain, taxOwed, afterTax, taxRate, color) {
    if (gain == null) return '';
    const isGain = gain > 0;
    const isLoss = gain < 0;
    return `
      <div style="background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden">
        <!-- Header -->
        <div style="padding:12px 16px 10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:${color}">${label}</span>
            <span style="font-size:10px;color:var(--text3);margin-left:6px">${(taxRate*100).toFixed(1)}% total tax rate</span>
          </div>
          <span style="font-size:13px;font-weight:600;font-family:var(--mono)" class="${signClass(gain)}">${gain>=0?'+':''}${fmt$(gain)} P&L</span>
        </div>
        ${isLoss ? `
        <!-- Loss: no tax owed -->
        <div style="padding:12px 16px;display:flex;align-items:center;gap:8px">
          <span style="font-size:18px">ðŸ’š</span>
          <div>
            <div style="font-size:12px;font-weight:600;color:var(--green)">No tax owed on a loss</div>
            <div style="font-size:11px;color:var(--text3);margin-top:1px">You may be able to harvest this loss to offset other gains</div>
          </div>
        </div>` : `
        <!-- Gain: show breakdown -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr">
          <div style="padding:12px 14px;border-right:1px solid var(--border)">
            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:3px">Gross Gain</div>
            <div style="font-size:14px;font-weight:700;font-family:var(--mono);color:var(--green)">+${fmt$(gain)}</div>
          </div>
          <div style="padding:12px 14px;border-right:1px solid var(--border)">
            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:3px">Est. Tax</div>
            <div style="font-size:14px;font-weight:700;font-family:var(--mono);color:var(--red)">âˆ’${fmt$(taxOwed)}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:1px">(${(taxRate*100).toFixed(1)}%)</div>
          </div>
          <div style="padding:12px 14px">
            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.4px;color:var(--text3);margin-bottom:3px">After Tax</div>
            <div style="font-size:14px;font-weight:700;font-family:var(--mono);color:var(--green)">+${fmt$(afterTax)}</div>
          </div>
        </div>`}
      </div>`;
  }

  const section = document.createElement('div');
  section.id = 'lt-st-section';
  section.style.margin = '0 16px 16px';

  section.innerHTML = `
    <p class="section-label" style="padding:0;margin-bottom:10px">Long-Term vs Short-Term</p>
    <!-- Visual bar -->
    <div style="background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;margin-bottom:12px">
      <div style="padding:14px 16px 10px">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:11px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:0.4px">Long-Term (&gt;1yr)</span>
          <span style="font-size:11px;font-weight:600;color:var(--blue);text-transform:uppercase;letter-spacing:0.4px">Short-Term (&lt;1yr)</span>
        </div>
        <div style="height:10px;border-radius:5px;background:var(--surface2);overflow:hidden;display:flex">
          <div style="width:${ltPct.toFixed(1)}%;background:var(--green);border-radius:5px 0 0 5px;transition:width 0.4s"></div>
          <div style="width:${stPct.toFixed(1)}%;background:var(--blue);border-radius:0 5px 5px 0;transition:width 0.4s"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <span style="font-size:11px;color:var(--text3);font-family:var(--mono)">${ltPct.toFixed(0)}% Â· ${fmtNum(ltShares,4)} shares</span>
          <span style="font-size:11px;color:var(--text3);font-family:var(--mono)">${fmtNum(stShares,4)} shares Â· ${stPct.toFixed(0)}%</span>
        </div>
      </div>
      <!-- LT/ST detail grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;border-top:1px solid var(--border)">
        <div style="padding:12px 16px;border-right:1px solid var(--border)">
          <div style="font-size:11px;color:var(--green);font-weight:600;text-transform:uppercase;letter-spacing:0.4px;margin-bottom:4px">Long-Term</div>
          <div style="font-size:15px;font-weight:600;font-family:var(--mono)">${fmtNum(ltShares,4)} <span style="font-size:11px;color:var(--text3)">shares</span></div>
          <div style="font-size:12px;color:var(--text3);font-family:var(--mono);margin-top:2px">Cost ${fmt$(ltCost)}</div>
          ${ltValue != null ? `<div style="font-size:12px;font-family:var(--mono);margin-top:2px" class="${signClass(ltUnrealized)}">${ltUnrealized>=0?'+':''}${fmt$(ltUnrealized)} P&L</div>` : ''}
        </div>
        <div style="padding:12px 16px">
          <div style="font-size:11px;color:var(--blue);font-weight:600;text-transform:uppercase;letter-spacing:0.4px;margin-bottom:4px">Short-Term</div>
          <div style="font-size:15px;font-weight:600;font-family:var(--mono)">${fmtNum(stShares,4)} <span style="font-size:11px;color:var(--text3)">shares</span></div>
          <div style="font-size:12px;color:var(--text3);font-family:var(--mono);margin-top:2px">Cost ${fmt$(stCost)}</div>
          ${stValue != null ? `<div style="font-size:12px;font-family:var(--mono);margin-top:2px" class="${signClass(stUnrealized)}">${stUnrealized>=0?'+':''}${fmt$(stUnrealized)} P&L</div>` : ''}
        </div>
      </div>
    </div>

    <!-- Tax estimate section -->
    <p class="section-label" style="padding:0;margin-bottom:10px">Est. Tax if Sold Today
      <span style="font-size:10px;font-weight:400;color:var(--text3);margin-left:6px">Colorado Â· ~$65â€“70k income</span>
    </p>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:4px">
      ${ltShares > 0 ? taxRow('Long-Term (15% fed + 4.4% CO)', ltUnrealized, ltTaxOwed, ltAfterTax, TAX_LT, 'var(--green)') : ''}
      ${stShares > 0 ? taxRow('Short-Term (22% fed + 4.4% CO)', stUnrealized, stTaxOwed, stAfterTax, TAX_ST, 'var(--blue)') : ''}
    </div>
    <div style="font-size:10px;color:var(--text3);line-height:1.5;margin-top:8px;padding:10px 12px;background:var(--surface2);border-radius:var(--radius-sm)">
      âš  Estimates only â€” based on 2024 federal rates and Colorado 4.40% flat rate. Does not account for deductions, AMT, net investment income tax, or other income. Consult a tax professional before making decisions.
    </div>
  `;

  // Insert before the purchase history section label
  const historyLabel = document.querySelector('#screen-detail .section-label:last-of-type');
  if (historyLabel) {
    historyLabel.parentNode.insertBefore(section, historyLabel);
  } else {
    document.getElementById('screen-detail').appendChild(section);
  }
}

function renderDetailTransactions(ticker) {
  const txs = state.transactions
    .filter(t => t.ticker === ticker)
    .sort((a,b) => new Date(a.date) - new Date(b.date));

  const el = document.getElementById('detail-tx-list');
  if (!txs.length) {
    el.innerHTML = '<div class="empty-state" style="padding:24px"><p>No transactions for this stock</p></div>';
    return;
  }

  const currentPrice = state.prices[ticker]?.price;

  el.innerHTML = txs.map(tx => {
    const total = tx.shares * tx.price;
    const currentVal = currentPrice ? tx.shares * currentPrice : null;
    const gain = currentVal != null ? currentVal - total : null;
    const gainPct = gain != null && total > 0 ? (gain / total) * 100 : null;
    const gainSign = gain != null ? signClass(gain) : '';
    const isBuy = tx.type === 'buy';

    return `<div class="transaction-card" style="flex-direction:column;gap:0;padding:0;overflow:hidden">
      <!-- Top row: dot + ticker + badge + edit -->
      <div style="display:flex;align-items:center;gap:10px;padding:12px 14px 8px">
        <div class="tx-dot ${tx.type}"></div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-weight:600;font-size:14px">${fmtDate(tx.date)}</span>
            <span class="tx-badge ${tx.type}">${tx.type.toUpperCase()}</span>
          </div>
          <div style="font-size:12px;color:var(--text3);margin-top:2px">${fmtNum(tx.shares,6)} shares @ ${fmt$(tx.price)} = ${isBuy?'-':'+'}${fmt$(total)}</div>
        </div>
        <button class="tx-edit-btn" onclick="openEditModal('${tx.id}')">âœï¸</button>
      </div>
      ${isBuy && currentPrice ? `
      <!-- Performance row -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;border-top:1px solid var(--border);background:var(--surface2)">
        <div style="padding:10px 14px;border-right:1px solid var(--border)">
          <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.4px">Current Value</div>
          <div style="font-size:13px;font-weight:600;font-family:var(--mono);margin-top:2px">${fmt$(currentVal)}</div>
        </div>
        <div style="padding:10px 14px;border-right:1px solid var(--border)">
          <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.4px">Gain / Loss</div>
          <div style="font-size:13px;font-weight:600;font-family:var(--mono);margin-top:2px" class="${gainSign}">${gain>=0?'+':''}${fmt$(gain)}</div>
        </div>
        <div style="padding:10px 14px">
          <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.4px">Return</div>
          <div style="font-size:13px;font-weight:600;font-family:var(--mono);margin-top:2px" class="${gainSign}">${fmtPct(gainPct)}</div>
        </div>
      </div>` : ''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
  const txs = [...state.transactions].sort((a,b) => b.timestamp - a.timestamp);
  document.getElementById('history-count').textContent = `${txs.length} transactions`;
  const el = document.getElementById('history-list');
  if (!txs.length) {
    el.innerHTML = `<div class="empty-state"><div class="icon">ðŸ“‹</div><h3>No transactions</h3><p>Your trade history will appear here</p></div>`;
    return;
  }
  el.innerHTML = txs.map(tx => buildTxCard(tx, true)).join('');
}

function buildTxCard(tx, showEdit=false) {
  const total = tx.shares * tx.price;
  return `<div class="transaction-card">
    <div class="tx-dot ${tx.type}"></div>
    <div class="tx-info">
      <div class="tx-main">
        <span style="font-weight:600">${tx.ticker}</span>
        <span class="tx-badge ${tx.type}">${tx.type.toUpperCase()}</span>
      </div>
      <div class="tx-sub">${fmtNum(tx.shares,6)} shares @ ${fmt$(tx.price)} Â· ${fmtDate(tx.date)}</div>
    </div>
    <div class="tx-amount ${tx.type==='buy'?'negative':'positive'}">${tx.type==='buy'?'-':'+'}${fmt$(total)}</div>
    ${showEdit ? `<button class="tx-edit-btn" onclick="openEditModal('${tx.id}')">âœï¸</button>` : ''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function newsTimeAgo(unixSec) {
  const diff = Math.floor(Date.now()/1000) - unixSec;
  if (diff < 3600)  return Math.floor(diff/60)+'m ago';
  if (diff < 86400) return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

function newsCard(a) {
  const headline = (a.headline || a.summary || '').slice(0,140);
  const url = a.url || '#';
  const img = a.image || '';
  const src = a.source || '';
  const time = a.datetime ? newsTimeAgo(a.datetime) : '';
  return `<div class="news-card">
    <a href="${url}" target="_blank" rel="noopener">
      ${img ? `<img class="news-thumb" src="${img}" alt="" loading="lazy" onerror="this.style.display='none'">` : ''}
      <div class="news-body">
        <div class="news-headline">${headline}</div>
        <div class="news-meta">
          ${src ? `<span class="news-source">${src}</span>` : ''}
          ${time ? `<span>${time}</span>` : ''}
        </div>
      </div>
    </a>
  </div>`;
}

function secHdr(title) {
  return `<div class="news-sec-hdr">${title}</div>`;
}

function cardWrap(html) {
  return `<div style="margin:0 16px 4px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)">${html}</div>`;
}

async function renderNews() {
  const container = document.getElementById('news-container');
  if (!container) return;
  const key = state.settings.apiKey;

  if (!key) {
    container.innerHTML = `<div style="padding:40px 20px;text-align:center;color:var(--text3)">
      <div style="font-size:32px;margin-bottom:12px">ðŸ”‘</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px">API Key Required</div>
      <div style="font-size:13px">Add your Finnhub API key in Settings to see market intelligence</div>
    </div>`;
    return;
  }

  container.innerHTML = `<div style="padding:24px 16px;text-align:center;color:var(--text3);font-size:13px">Loading market dataâ€¦</div>`;

  const tickers = [...new Set(state.transactions.map(t => t.ticker))];
  const sections = [];

  // â”€â”€ 1. PORTFOLIO SNAPSHOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const holdings = getHoldings().filter(h => h.shares > 0);
  if (holdings.length) {
    const totalVal  = holdings.reduce((s,h)=>s+(h.currentValue||0),0);
    const totalCost = holdings.reduce((s,h)=>s+h.costBasis,0);
    const totalPnl  = totalVal - totalCost;
    const pnlPct    = totalCost>0 ? totalPnl/totalCost*100 : 0;

    const tiles = holdings.map(h => {
      const chg = state.prices[h.ticker]?.change1d;
      const cls = chg != null ? signClass(chg) : '';
      return `<div style="flex:1;min-width:0;padding:10px 12px;border-right:1px solid var(--border);cursor:pointer" onclick="navigate('detail','${h.ticker}')">
        <div style="font-size:11px;font-weight:700;color:var(--text2)">${h.ticker}</div>
        <div style="font-size:14px;font-weight:700;font-family:var(--mono);margin-top:2px">${h.currentValue!=null?fmt$(h.currentValue):'â€”'}</div>
        <div style="font-size:11px;margin-top:1px" class="${cls}">${chg!=null?(chg>=0?'+':'')+fmt$(chg)+' today':'â€”'}</div>
      </div>`;
    }).join('');

    sections.push(secHdr('ðŸ“Š Portfolio'));
    sections.push(cardWrap(`
      <div style="display:flex;overflow-x:auto;border-bottom:1px solid var(--border)">${tiles}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px">
        <div>
          <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3)">Total Value</div>
          <div style="font-size:18px;font-weight:700;font-family:var(--mono)">${fmt$(totalVal)}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3)">Total P&L</div>
          <div style="font-size:18px;font-weight:700;font-family:var(--mono)" class="${signClass(totalPnl)}">${totalPnl>=0?'+':''}${fmt$(totalPnl)}</div>
          <div style="font-size:12px" class="${signClass(totalPnl)}">${fmtPct(pnlPct)}</div>
        </div>
      </div>`));
  }

  // â”€â”€ 2. ANALYST RATINGS (all holdings) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const recResults = await Promise.all(tickers.map(async ticker => {
    try {
      const r = await fetch(`https://finnhub.io/api/v1/stock/recommendation?symbol=${ticker}&token=${key}`);
      const data = await r.json();
      if (!Array.isArray(data) || !data.length) return null;
      return { ticker, rec: data[0] };
    } catch(e) { return null; }
  }));
  const validRecs = recResults.filter(Boolean);
  if (validRecs.length) {
    sections.push(secHdr('ðŸ“ˆ Analyst Ratings'));
    for (const { ticker, rec } of validRecs) {
      const total = (rec.strongBuy||0)+(rec.buy||0)+(rec.hold||0)+(rec.sell||0)+(rec.strongSell||0);
      if (!total) continue;
      const bullish = (rec.strongBuy||0)+(rec.buy||0);
      const bearish = (rec.sell||0)+(rec.strongSell||0);
      let consensus='Hold', cColor='#f59e0b';
      if (bullish/total>=0.5){consensus='Buy';cColor='#1a9e5c';}
      else if(bearish/total>=0.5){consensus='Sell';cColor='#d63b3b';}
      const bars=[
        {label:'Strong Buy', val:rec.strongBuy||0, color:'#1a9e5c'},
        {label:'Buy',        val:rec.buy||0,        color:'#4caf50'},
        {label:'Hold',       val:rec.hold||0,       color:'#f59e0b'},
        {label:'Sell',       val:rec.sell||0,       color:'#f97316'},
        {label:'Strong Sell',val:rec.strongSell||0, color:'#d63b3b'},
      ];
      sections.push(cardWrap(`
        <div style="padding:12px 14px 10px">
          <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:10px">
            <span style="font-size:14px;font-weight:700;cursor:pointer" onclick="navigate('detail','${ticker}')">${ticker}</span>
            <span style="font-size:11px;color:var(--text3)">${total} analysts${rec.period?' Â· '+rec.period:''}</span>
            <span style="font-size:13px;font-weight:700;color:${cColor}">${consensus}</span>
          </div>
          ${bars.map(b=>`<div class="analyst-row">
            <div class="analyst-lbl">${b.label}</div>
            <div class="analyst-track"><div class="analyst-fill" style="width:${(b.val/total*100).toFixed(1)}%;background:${b.color}"></div></div>
            <div class="analyst-cnt">${b.val}</div>
          </div>`).join('')}
        </div>`));
    }
  }

  // â”€â”€ 3. PRICE TARGETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ptResults = await Promise.all(tickers.map(async ticker => {
    try {
      const r = await fetch(`https://finnhub.io/api/v1/stock/price-target?symbol=${ticker}&token=${key}`);
      const d = await r.json();
      if (!d?.targetMean) return null;
      return { ticker, d };
    } catch(e) { return null; }
  }));
  const validPT = ptResults.filter(Boolean);
  if (validPT.length) {
    sections.push(secHdr('ðŸŽ¯ Price Targets'));
    const ptTiles = validPT.map(({ticker, d}) => {
      const price = state.prices[ticker]?.price;
      const updown = price && d.targetMean ? ((d.targetMean-price)/price*100).toFixed(1) : null;
      const cls = updown ? (parseFloat(updown)>=0?'positive':'negative') : '';
      return `<div style="flex:1;min-width:140px;padding:12px 14px;border-right:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:4px;cursor:pointer" onclick="navigate('detail','${ticker}')">${ticker}</div>
        <div style="font-size:16px;font-weight:700;font-family:var(--mono)">${fmt$(d.targetMean)}</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Hi ${fmt$(d.targetHigh)} Â· Lo ${fmt$(d.targetLow)}</div>
        ${updown?`<div style="font-size:11px;margin-top:2px" class="${cls}">${parseFloat(updown)>=0?'+':''}${updown}% from current</div>`:''}
      </div>`;
    }).join('');
    sections.push(cardWrap(`<div style="display:flex;flex-wrap:wrap">${ptTiles}</div>`));
  }

  // â”€â”€ 4. UPCOMING EARNINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const today = new Date().toISOString().split('T')[0];
    const future = new Date(Date.now()+60*86400000).toISOString().split('T')[0];
    const r = await fetch(`https://finnhub.io/api/v1/calendar/earnings?from=${today}&to=${future}&token=${key}`);
    const d = await r.json();
    const items = (d.earningsCalendar||[]).filter(e=>tickers.includes(e.symbol)).slice(0,6);
    if (items.length) {
      sections.push(secHdr('ðŸ“… Upcoming Earnings'));
      const rows = items.map(e=>{
        const dt = new Date(e.date+'T12:00:00Z');
        return `<div class="cal-item">
          <div class="cal-datebox">
            <div class="cal-mon">${dt.toLocaleDateString('en-US',{month:'short'})}</div>
            <div class="cal-day">${dt.getUTCDate()}</div>
          </div>
          <div class="cal-info">
            <div class="cal-title" style="cursor:pointer" onclick="navigate('detail','${e.symbol}')">${e.symbol} Earnings</div>
            <div class="cal-sub">${e.hour==='bmo'?'Before Market Open':e.hour==='amc'?'After Market Close':e.hour||''}${e.epsEstimate?` Â· EPS est. ${fmt$(e.epsEstimate)}`:''}</div>
          </div>
        </div>`;
      }).join('');
      sections.push(cardWrap(rows));
    }
  } catch(e){}

  // â”€â”€ 5. NEWS SENTIMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sentResults = await Promise.all(tickers.map(async ticker => {
    try {
      const r = await fetch(`https://finnhub.io/api/v1/news-sentiment?symbol=${ticker}&token=${key}`);
      const d = await r.json();
      if (!d?.sentiment) return null;
      return { ticker, d };
    } catch(e){ return null; }
  }));
  const validSent = sentResults.filter(Boolean);
  if (validSent.length) {
    sections.push(secHdr('ðŸ’¬ News Sentiment'));
    const sentTiles = validSent.map(({ticker, d}) => {
      const bull = d.sentiment?.bullishPercent!=null ? (d.sentiment.bullishPercent*100).toFixed(0) : null;
      const buzz = d.buzz?.articlesInLastWeek ?? d.buzz?.weeklyAverage ?? null;
      return `<div style="flex:1;min-width:120px;padding:12px 14px;border-right:1px solid var(--border);cursor:pointer" onclick="navigate('detail','${ticker}')">
        <div style="font-size:12px;font-weight:700;margin-bottom:4px">${ticker}</div>
        ${bull?`<div style="font-size:15px;font-weight:700;font-family:var(--mono)" class="positive">+${bull}% bullish</div>`:'<div style="font-size:13px;color:var(--text3)">â€”</div>'}
        ${buzz?`<div style="font-size:11px;color:var(--text3);margin-top:2px">${buzz} articles/wk</div>`:''}
      </div>`;
    }).join('');
    sections.push(cardWrap(`<div style="display:flex;flex-wrap:wrap">${sentTiles}</div>`));
  }

  // â”€â”€ 6. UPGRADES & DOWNGRADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const upgradeResults = await Promise.all(tickers.slice(0,4).map(async ticker => {
      const r = await fetch(`https://finnhub.io/api/v1/stock/upgrade-downgrade?symbol=${ticker}&token=${key}`);
      const data = await r.json();
      return Array.isArray(data) ? data.slice(0,3).map(u=>({...u,symbol:ticker})) : [];
    }));
    const allUpgrades = upgradeResults.flat().sort((a,b)=>(b.gradeDate||'').localeCompare(a.gradeDate||'')).slice(0,10);
    if (allUpgrades.length) {
      sections.push(secHdr('â¬†ï¸ Upgrades & Downgrades'));
      const rows = allUpgrades.map(u=>{
        const badge = (u.action||'').toLowerCase();
        const col = badge.includes('upgrade')?'var(--green)':badge.includes('downgrade')?'var(--red)':'var(--text3)';
        return `<div style="display:flex;align-items:flex-start;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border)">
          <div style="min-width:44px;font-size:13px;font-weight:700;cursor:pointer" onclick="navigate('detail','${u.symbol}')">${u.symbol}</div>
          <div style="flex:1">
            <div style="font-size:12px;font-weight:600">${u.firm||'Unknown'}</div>
            <div style="font-size:11px;color:var(--text3)">${u.fromGrade||'â€”'} â†’ <span style="font-weight:600;color:${col}">${u.toGrade||'â€”'}</span></div>
          </div>
          <div style="font-size:11px;color:var(--text3);white-space:nowrap">${u.gradeDate||''}</div>
        </div>`;
      }).join('');
      sections.push(cardWrap(rows));
    }
  } catch(e){}

  // â”€â”€ 7. MARKET HEADLINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const r = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${key}`);
    const articles = await r.json();
    if (Array.isArray(articles) && articles.length) {
      sections.push(secHdr('ðŸŒ Market Headlines'));
      sections.push(`<div style="padding:0 16px 4px;display:flex;flex-direction:column;gap:8px">${articles.slice(0,6).map(newsCard).join('')}</div>`);
    }
  } catch(e){}

  // â”€â”€ 8. STOCK NEWS (2â€“3 per holding) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const stockNewsResults = await Promise.all(tickers.map(async ticker => {
    try {
      const to   = new Date().toISOString().split('T')[0];
      const from = new Date(Date.now()-14*86400000).toISOString().split('T')[0];
      const r = await fetch(`https://finnhub.io/api/v1/company-news?symbol=${ticker}&from=${from}&to=${to}&token=${key}`);
      const articles = await r.json();
      if (!Array.isArray(articles)||!articles.length) return null;
      return { ticker, articles: articles.slice(0,3) };
    } catch(e){ return null; }
  }));
  for (const item of stockNewsResults.filter(Boolean)) {
    sections.push(secHdr(`ðŸ“° ${item.ticker} News`));
    sections.push(`<div style="padding:0 16px 4px;display:flex;flex-direction:column;gap:8px">${item.articles.map(newsCard).join('')}</div>`);
  }

  sections.push('<div style="height:16px"></div>');
  container.innerHTML = sections.join('') || `<div style="padding:24px;text-align:center;color:var(--text3);font-size:13px">No data available â€” check API key in Settings</div>`;
}

function addTwitterAccount() {
  const input = document.getElementById('twitter-add-input');
  if (!input) return;
  let handle = input.value.trim().replace(/^@/, '');
  if (!handle) return;
  if (!/^[A-Za-z0-9_]{1,50}$/.test(handle)) { showToast('Invalid username', 'error'); return; }
  if (!state.settings.twitterAccounts) state.settings.twitterAccounts = [];
  if (state.settings.twitterAccounts.map(h=>h.toLowerCase()).includes(handle.toLowerCase())) {
    showToast('@'+handle+' already added', 'error'); return;
  }
  state.settings.twitterAccounts.push(handle);
  save(); input.value = '';
  renderTwitterAccountsList();
  showToast('@'+handle+' saved', 'success');
}

function removeTwitterAccount(handle) {
  state.settings.twitterAccounts = (state.settings.twitterAccounts||[]).filter(h=>h!==handle);
  save(); renderTwitterAccountsList();
}

function renderTwitterAccountsList() {
  const el = document.getElementById('twitter-accounts-list');
  if (!el) return;
  const accounts = state.settings.twitterAccounts || [];
  if (!accounts.length) { el.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:4px 0">No accounts added yet</div>'; return; }
  el.innerHTML = accounts.map(handle => `
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border-radius:var(--radius-sm);padding:9px 12px">
      <span style="font-size:13px;font-weight:500">@${handle}</span>
      <button onclick="removeTwitterAccount('${handle}')" style="background:none;border:none;color:var(--red);font-size:13px;cursor:pointer;padding:2px 6px;font-family:var(--font);font-weight:500">Remove</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings() {
  const urlInput = document.getElementById('sheets-url-input');
  if (urlInput) urlInput.value = state.settings.sheetsUrl || '';

  const keyInput = document.getElementById('av-api-key');
  if (keyInput) keyInput.value = state.settings.apiKey || '';

  const lastRef = document.getElementById('last-refresh-time');
  if (lastRef && state.settings.lastRefresh) {
    lastRef.textContent = new Date(state.settings.lastRefresh).toLocaleString();
  }

  renderTwitterAccountsList();
  updateSyncStatus('idle');
}

function updateSyncStatus(status, msg) {
  const dot = document.getElementById('sync-dot');
  const text = document.getElementById('sync-status-text');
  if (!dot || !text) return;
  const has = !!state.settings.sheetsUrl;
  if (!has) { dot.className = 'sync-dot'; text.textContent = 'Not configured'; return; }
  if (status === 'syncing') { dot.className = 'sync-dot syncing'; text.textContent = 'Syncingâ€¦'; }
  else if (status === 'ok') { dot.className = 'sync-dot connected'; text.textContent = msg || 'Connected'; }
  else if (status === 'error') { dot.className = 'sync-dot error'; text.textContent = msg || 'Error'; }
  else { dot.className = 'sync-dot connected'; text.textContent = 'Configured'; }
}

function saveSheetUrl() {
  state.settings.sheetsUrl = document.getElementById('sheets-url-input').value.trim();
  save();
  updateSyncStatus('idle');
}

function saveApiKey() {
  state.settings.apiKey = document.getElementById('av-api-key').value.trim();
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APPS_SCRIPT_CODE = `
function doGet(e) {
  return handleRequest(e);
}
function doPost(e) {
  return handleRequest(e);
}
function handleRequest(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var action = (e.parameter && e.parameter.action) || 
               (e.postData ? JSON.parse(e.postData.contents).action : 'read');
  var output;
  
  if (action === 'read') {
    var sheet = ss.getSheetByName('Transactions') || ss.insertSheet('Transactions');
    var data = sheet.getDataRange().getValues();
    output = ContentService.createTextOutput(JSON.stringify({ok:true, data:data}));
  } else if (action === 'write') {
    var body = JSON.parse(e.postData.contents);
    var sheet = ss.getSheetByName('Transactions') || ss.insertSheet('Transactions');
    sheet.clearContents();
    if (body.rows && body.rows.length) {
      sheet.getRange(1, 1, body.rows.length, body.rows[0].length).setValues(body.rows);
    }
    output = ContentService.createTextOutput(JSON.stringify({ok:true}));
  }
  
  return output.setMimeType(ContentService.MimeType.JSON);
}
`.trim();

document.getElementById('apps-script-code-display').textContent = APPS_SCRIPT_CODE.substring(0, 80) + 'â€¦ (tap to copy)';

function copyAppsScript() {
  navigator.clipboard.writeText(APPS_SCRIPT_CODE).then(() => {
    showToast('Code copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback
    const el = document.createElement('textarea');
    el.value = APPS_SCRIPT_CODE;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('Code copied!', 'success');
  });
}

// Silent background sync â€” called automatically after every transaction change.
// Saves locally first (already done before calling this), then pushes to Sheets quietly.
// Only shows a toast if it fails. No merge/read needed â€” we just overwrite with our local state.
async function syncInBackground() {
  const url = state.settings.sheetsUrl;
  if (!url) return; // not configured â€” silently skip
  try {
    const header = ['id','ticker','type','shares','price','date','timestamp'];
    const rows = [header, ...state.transactions.map(t => [t.id,t.ticker,t.type,t.shares,t.price,t.date,t.timestamp])];
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ action: 'write', rows })
    });
    const data = await res.json();
    if (data.ok) {
      updateSyncStatus('ok', 'Synced Â· ' + new Date().toLocaleTimeString());
    } else {
      throw new Error('Write failed');
    }
  } catch(err) {
    updateSyncStatus('error', 'Auto-sync failed');
    showToast('Sheet sync failed â€” tap Sync Now in Settings to retry', 'error');
  }
}

// Pull transactions from Google Sheets into local state (read-only, no write).
// Used on first load on a new device to restore data.
async function syncFromSheets() {
  const url = state.settings.sheetsUrl;
  if (!url) return;

  // Show loading state on the sync button if it exists
  const syncBtn = document.getElementById('sync-from-sheets-btn');
  if (syncBtn) { syncBtn.disabled = true; syncBtn.textContent = 'Loadingâ€¦'; }

  try {
    // Apps Script redirects GETs â€” must use redirect:'follow' and POST for reliability.
    // We use POST with action=read to avoid redirect issues with cross-origin GETs.
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ action: 'read' }),
      redirect: 'follow'
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch(e) { throw new Error('Invalid JSON response: ' + text.substring(0, 100)); }

    if (!data.ok) throw new Error('Sheet returned ok:false');

    if (data.data && data.data.length > 1) {
      const sheetTxs = data.data.slice(1).map(r => ({
        id:        String(r[0]),
        ticker:    String(r[1] || '').toUpperCase().trim(),
        type:      String(r[2] || '').toLowerCase().trim(),
        shares:    parseFloat(r[3]),
        price:     parseFloat(r[4]),
        date:      normalizeDate(r[5]),
        timestamp: parseInt(r[6])
      })).filter(t => t.id && t.ticker && (t.type==='buy'||t.type==='sell') && !isNaN(t.shares) && !isNaN(t.price));

      if (sheetTxs.length > 0) {
        state.transactions = sheetTxs;
        state.transactions.sort((a, b) => b.timestamp - a.timestamp);
        save();
        renderHome();
        updateSyncStatus('ok', 'Loaded from Sheets Â· ' + new Date().toLocaleTimeString());

        // Check if any holdings are missing cached prices
        const tickers = [...new Set(sheetTxs.map(t => t.ticker))];
        const missingPrices = tickers.filter(t => !state.prices[t]?.price);

        if (missingPrices.length > 0 && state.settings.apiKey && !wasRateLimitedToday() && getRemainingQuota() > 0) {
          showToast(`Loaded ${sheetTxs.length} transactions â€” fetching pricesâ€¦`, 'success');
          setTimeout(() => refreshAllPrices(), 600);
        } else if (missingPrices.length > 0) {
          showToast(`Loaded ${sheetTxs.length} transactions â€” tap Refresh to load prices`, 'success');
        } else {
          showToast(`Loaded ${sheetTxs.length} transactions from Google Sheets`, 'success');
        }
      } else {
        showToast('Sheet connected but no valid transactions found', 'error');
      }
    } else {
      showToast('Sheet is empty â€” no transactions to load', '');
    }
  } catch(err) {
    console.error('syncFromSheets error:', err);
    showToast('Could not load from Sheets: ' + err.message, 'error');
  } finally {
    if (syncBtn) { syncBtn.disabled = false; syncBtn.textContent = 'Load from Sheets'; }
  }
}

async function syncNow() {
  const url = state.settings.sheetsUrl;
  if (!url) { showToast('Add your Apps Script URL in Settings', 'error'); return; }

  updateSyncStatus('syncing');

  // Convert transactions to rows for sheets
  const header = ['id','ticker','type','shares','price','date','timestamp'];
  const rows = [header, ...state.transactions.map(t => [t.id,t.ticker,t.type,t.shares,t.price,t.date,t.timestamp])];

  try {
    // First try to read from sheets â€” use POST to avoid redirect issues
    const readRes = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ action: 'read' }),
      redirect: 'follow'
    });
    const readData = await readRes.json();

    if (readData.ok && readData.data && readData.data.length > 1) {
      // Sheet has data â€” merge (sheet is source of truth for existing, local for new)
      const sheetTxs = readData.data.slice(1).map(r => ({
        id: String(r[0]), ticker: r[1], type: r[2],
        shares: parseFloat(r[3]), price: parseFloat(r[4]),
        date: normalizeDate(r[5]),   // handle Sheets date formats
        timestamp: parseInt(r[6])
      })).filter(t => t.id && t.ticker);
      
      // Merge: keep all sheet txs + any local-only
      const sheetIds = new Set(sheetTxs.map(t=>t.id));
      const localOnly = state.transactions.filter(t => !sheetIds.has(t.id));
      state.transactions = [...sheetTxs, ...localOnly];
      state.transactions.sort((a,b) => b.timestamp - a.timestamp);
    }

    // Write merged data back
    const writeRows = [header, ...state.transactions.map(t => [t.id,t.ticker,t.type,t.shares,t.price,t.date,t.timestamp])];
    const writeRes = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({action:'write', rows: writeRows})
    });
    const writeData = await writeRes.json();
    
    if (writeData.ok) {
      save();
      updateSyncStatus('ok', 'Synced Â· ' + new Date().toLocaleTimeString());
      showToast('Synced with Google Sheets!', 'success');
      renderHome();
    } else {
      throw new Error('Write failed');
    }
  } catch(err) {
    updateSyncStatus('error', 'Sync failed');
    showToast('Sync failed. Check your URL.', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD / EDIT TRANSACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal(prefillTicker) {
  currentTxType = 'buy';
  document.getElementById('type-buy').className = 'type-btn buy active';
  document.getElementById('type-sell').className = 'type-btn sell';
  document.getElementById('tx-ticker').value = prefillTicker || '';
  document.getElementById('tx-shares').value = '';
  document.getElementById('tx-price').value = '';
  document.getElementById('tx-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('tx-total-preview').style.display = 'none';
  document.getElementById('autocomplete-list').classList.remove('show');
  
  // Set up total preview
  ['tx-shares','tx-price'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateTxPreview);
  });

  if (prefillTicker) {
    const p = state.prices[prefillTicker]?.price;
    if (p) document.getElementById('tx-price').value = p;
  }

  openModal('add-modal-overlay');
}

function updateTxPreview() {
  const shares = parseFloat(document.getElementById('tx-shares').value);
  const price = parseFloat(document.getElementById('tx-price').value);
  if (!isNaN(shares) && !isNaN(price) && shares > 0 && price > 0) {
    document.getElementById('tx-total-preview').style.display = 'block';
    document.getElementById('tx-total-val').textContent = fmt$(shares * price);
  } else {
    document.getElementById('tx-total-preview').style.display = 'none';
  }
}

function setTxType(type) {
  currentTxType = type;
  document.getElementById('type-buy').className = `type-btn buy${type==='buy'?' active':''}`;
  document.getElementById('type-sell').className = `type-btn sell${type==='sell'?' active':''}`;
}

function onTickerInput(val) {
  const list = document.getElementById('autocomplete-list');
  const q = val.trim().toUpperCase();
  if (!q) { list.classList.remove('show'); return; }

  // Search live listing first (Alpha Vantage full list), fall back to hardcoded DB
  const searchSource = LIVE_LISTING.length > 100 ? LIVE_LISTING : STOCK_DB_DEDUP;

  // Scoring: exact ticker match first, then ticker starts-with, then name contains
  const scored = [];
  for (const s of searchSource) {
    const t = s.t.toUpperCase();
    const n = (s.n || '').toUpperCase();
    if (t === q)               scored.push({ s, score: 0 });
    else if (t.startsWith(q)) scored.push({ s, score: 1 });
    else if (n.startsWith(q)) scored.push({ s, score: 2 });
    else if (t.includes(q))   scored.push({ s, score: 3 });
    else if (n.includes(q))   scored.push({ s, score: 4 });
    if (scored.length >= 50) break; // cap early for performance
  }
  scored.sort((a, b) => a.score - b.score);
  const matches = scored.slice(0, 10).map(x => x.s);

  // Show a "use anyway" option if no exact match
  const exactMatch = matches.find(s => s.t.toUpperCase() === q);
  const items = [...matches];
  if (!exactMatch && q.length >= 1) {
    items.push({ t: q, n: LIVE_LISTING.length > 100 ? 'Not found â€” add manually' : 'Enter manually (loading full listâ€¦)', _manual: true });
  }

  if (!items.length) { list.classList.remove('show'); return; }

  list.innerHTML = items.map(s => {
    const exchange = s.e ? `<span style="font-size:10px;color:var(--text3);margin-left:4px">${s.e}</span>` : '';
    return `<div class="autocomplete-item" onclick="selectTicker('${s.t.replace(/'/g,"\\'")}')">
      <div class="autocomplete-ticker">${s.t}${exchange}</div>
      <div class="autocomplete-name" style="${s._manual ? 'color:var(--blue);font-style:italic' : ''}">${s.n}</div>
    </div>`;
  }).join('');
  list.classList.add('show');
}

function selectTicker(ticker) {
  document.getElementById('tx-ticker').value = ticker;
  document.getElementById('autocomplete-list').classList.remove('show');
  // Try to fill in current price
  const p = state.prices[ticker]?.price;
  if (p) document.getElementById('tx-price').value = p.toFixed(2);
  document.getElementById('tx-shares').focus();
}

function saveTransaction() {
  const ticker = document.getElementById('tx-ticker').value.trim().toUpperCase();
  const shares = parseFloat(document.getElementById('tx-shares').value);
  const price = parseFloat(document.getElementById('tx-price').value);
  const date = document.getElementById('tx-date').value;

  if (!ticker) { showToast('Enter a ticker symbol', 'error'); return; }
  if (!shares || shares <= 0) { showToast('Enter valid share count', 'error'); return; }
  if (!price || price <= 0) { showToast('Enter valid price', 'error'); return; }
  if (!date) { showToast('Enter a date', 'error'); return; }

  // Validate sell
  if (currentTxType === 'sell') {
    const holdings = getHoldings();
    const h = holdings.find(x => x.ticker === ticker);
    if (!h) { showToast(`You don't own ${ticker}`, 'error'); return; }
    if (shares > h.shares) { showToast(`You only own ${fmtNum(h.shares,4)} shares`, 'error'); return; }
  }

  const tx = {
    id: Date.now() + '-' + Math.random().toString(36).slice(2,7),
    ticker,
    type: currentTxType,
    shares,
    price,
    date,
    timestamp: Date.now()
  };

  state.transactions.push(tx);
  save();
  closeModal('add-modal-overlay');
  renderHome();
  showToast(`${currentTxType === 'buy' ? 'Bought' : 'Sold'} ${fmtNum(shares,4)} ${ticker}!`, 'success');

  // Auto-sync to Google Sheets in background
  syncInBackground();

  // Auto-fetch price if new ticker
  if (!state.prices[ticker] && state.settings.apiKey) {
    fetchPrice(ticker).then(data => {
      if (data) { state.prices[ticker] = data; save(); renderHome(); }
    });
  }
}

function openEditModal(id) {
  const tx = state.transactions.find(t => t.id === id);
  if (!tx) return;
  currentEditId = id;
  editTxType = tx.type;
  
  document.getElementById('edit-tx-id').value = id;
  document.getElementById('edit-ticker').value = tx.ticker;
  document.getElementById('edit-shares').value = tx.shares;
  document.getElementById('edit-price').value = tx.price;
  document.getElementById('edit-date').value = tx.date;
  
  document.getElementById('edit-type-buy').className = `type-btn buy${tx.type==='buy'?' active':''}`;
  document.getElementById('edit-type-sell').className = `type-btn sell${tx.type==='sell'?' active':''}`;
  
  openModal('edit-modal-overlay');
}

function setEditTxType(type) {
  editTxType = type;
  document.getElementById('edit-type-buy').className = `type-btn buy${type==='buy'?' active':''}`;
  document.getElementById('edit-type-sell').className = `type-btn sell${type==='sell'?' active':''}`;
}

function saveEditTransaction() {
  const id = document.getElementById('edit-tx-id').value;
  const shares = parseFloat(document.getElementById('edit-shares').value);
  const price = parseFloat(document.getElementById('edit-price').value);
  const date = document.getElementById('edit-date').value;

  if (!shares || shares <= 0) { showToast('Enter valid share count', 'error'); return; }
  if (!price || price <= 0) { showToast('Enter valid price', 'error'); return; }
  if (!date) { showToast('Enter a date', 'error'); return; }

  const idx = state.transactions.findIndex(t => t.id === id);
  if (idx === -1) return;
  
  state.transactions[idx] = { ...state.transactions[idx], type: editTxType, shares, price, date };
  save();
  closeModal('edit-modal-overlay');
  renderHome();
  if (currentDetailTicker) renderDetail(currentDetailTicker);
  renderHistory();
  showToast('Transaction updated', 'success');

  // Auto-sync to Google Sheets in background
  syncInBackground();
}

function confirmDeleteTransaction() {
  showConfirm('Delete Transaction', 'This cannot be undone. The transaction will be permanently removed.', 'Delete', () => {
    const id = document.getElementById('edit-tx-id').value;
    state.transactions = state.transactions.filter(t => t.id !== id);
    save();
    closeModal('edit-modal-overlay');
    renderHome();
    if (currentDetailTicker) renderDetail(currentDetailTicker);
    renderHistory();
    showToast('Transaction deleted', '');

    // Auto-sync to Google Sheets in background
    syncInBackground();
  }, true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA EXPORT / IMPORT / CLEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const data = { transactions: state.transactions, prices: state.prices, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `stock-tracker-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Data exported!', 'success');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.transactions) {
        state.transactions = data.transactions;
        if (data.prices) state.prices = { ...state.prices, ...data.prices };
        save();
        renderHome();
        showToast('Data imported!', 'success');
      } else {
        showToast('Invalid file format', 'error');
      }
    } catch {
      showToast('Failed to parse file', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function confirmClearData() {
  showConfirm('Clear All Data', 'This will permanently delete all your transactions and portfolio data. This cannot be undone.', 'Clear All', () => {
    state.transactions = [];
    state.prices = {};
    save();
    renderHome();
    showToast('All data cleared', '');
  }, true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
  document.getElementById('autocomplete-list')?.classList.remove('show');
}
function closeModalOnOverlay(e, id) {
  if (e.target.id === id) closeModal(id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIRM DIALOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showConfirm(title, msg, okLabel, cb, danger=false) {
  confirmCallback = cb;
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent = msg;
  const okBtn = document.getElementById('confirm-ok-btn');
  okBtn.textContent = okLabel;
  okBtn.className = 'confirm-ok' + (danger ? ' danger' : '');
  document.getElementById('confirm-overlay').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('open');
  confirmCallback = null;
}
function runConfirm() {
  closeConfirm();
  if (confirmCallback) confirmCallback();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  load();
  navigate('home');

  // Load the full Alpha Vantage stock listing for autocomplete (async, non-blocking)
  loadLiveListing();

  // Always pull from Sheets on startup to stay in sync across devices.
  // syncFromSheets will auto-trigger refreshAllPrices after loading if prices are missing.
  if (state.settings.sheetsUrl) {
    syncFromSheets();
  } else if (state.settings.apiKey && state.transactions.length) {
    // No Sheets configured â€” just refresh prices directly on open
    setTimeout(() => refreshAllPrices(), 500);
  }

  // Refresh prices when app comes back to foreground (e.g. switching tabs/apps)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && state.settings.apiKey && state.transactions.length) {
      setTimeout(() => refreshAllPrices(), 300);
    }
  });

  // Close autocomplete on outside click
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.autocomplete-wrap')) {
      document.getElementById('autocomplete-list')?.classList.remove('show');
    }
  });

  // Tick every minute to keep "X minutes ago" label fresh
  setInterval(() => {
    if (document.getElementById('home-last-refresh')) renderRefreshBar();
  }, 60000);

  // Auto-load news tab on startup (non-blocking, runs after prices)
  if (state.settings.apiKey && state.transactions.length) {
    setTimeout(() => renderNews(), 1500);
  }
}

init();
</script>
</body>
</html>
